<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級黑板 - 專屬雲端版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@600&family=Mali:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        /* === 黑板與聯絡簿樣式 === */
        .blackboard {
            background-color: #2b3a28;
            background-image: radial-gradient(#4a5d46 1px, transparent 1px), radial-gradient(#4a5d46 1px, transparent 1px);
            background-position: 0 0, 20px 20px; background-size: 40px 40px;
            box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.3);
            border: 12px solid #8B4513; border-radius: 8px; color: #fff;
            font-family: 'Noto Serif TC', serif;
        }
        .chalk-text { color: rgba(255, 255, 255, 0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .chalk-input {
            background: transparent; border: none; border-bottom: 1px dashed rgba(255,255,255,0.3);
            color: white; font-family: 'Noto Serif TC', serif; width: 100%; padding: 4px; transition: font-size 0.2s, height 0.2s;
        }
        .chalk-input:focus { outline: none; border-bottom: 1px solid white; background: rgba(255,255,255,0.1); }
        .sticky-note { background-color: #fef08a; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 4px; border-top: 10px solid rgba(255,255,0,0.3); }
        .duty-card { background-color: #e0f2fe; border-left: 4px solid #3b82f6; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
        @keyframes blinker { 50% { opacity: 0.3; color: red; } }
        .blink-active { animation: blinker 1.5s linear infinite; font-weight: bold; }
        
        /* === 通用介面樣式 === */
        .content-area { height: calc(100vh - 60px); overflow-y: hidden; }
        .scrollable-content { height: 100%; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .tab-btn {
            white-space: nowrap; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
            border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
        }
        .tab-active { background-color: #f3f4f6; color: #1e40af; border-bottom: 3px solid #1e40af; }
        .tab-inactive { background-color: white; color: #64748b; border-bottom: 3px solid transparent; }
        .tab-inactive:hover { background-color: #f1f5f9; }

        /* === 作業管理樣式 === */
        .workbook-bg { background-color: #ffffff; background-image: linear-gradient(rgba(200, 220, 200, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(200, 220, 200, 0.4) 1px, transparent 1px); background-size: 20px 20px; position: relative; }
        .student-grid-cell { min-height: 90px; display: flex; flex-direction: column; border-radius: 10px; transition: all 0.2s; position: relative; cursor: pointer; overflow: hidden; background-color: #22c55e; border: 2px solid #ffffff; box-shadow: 0 3px 5px rgba(0,0,0,0.12); }
        .student-grid-cell:hover { transform: translateY(-2px); background-color: #16a34a; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .student-grid-cell.incomplete { background-color: #fff1f2; border-color: #fecdd3; }
        .student-grid-cell.incomplete:hover { background-color: #ffe4e6; }
        .cell-tape { position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 30px; height: 15px; background-color: rgba(255,255,255,0.4); z-index: 0; }
        .cute-font { font-family: 'Mali', 'Noto Sans TC', cursive; }

        /* === 訂正系統樣式 (來自您的 txt) === */
        .correction-wrapper { font-family: 'Microsoft JhengHei', sans-serif; padding: 1.5rem; }
        .corr-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .corr-number-item { display: flex; align-items: center; justify-content: center; height: 40px; background-color: #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none; font-weight: bold; color: #64748b; }
        .corr-number-item:hover { background-color: #cbd5e1; }
        .corr-number-item.selected { background-color: #3b82f6; color: white; }
        
        .corr-frame { border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 20px; }
        .frame-bg-0 { background-color: #ffedd5; }
        .frame-bg-1 { background-color: #dcfce7; }
        .frame-bg-2 { background-color: #dbeafe; }
        .frame-bg-3 { background-color: #fae8ff; }
        .frame-bg-4 { background-color: #fee2e2; }
        .frame-bg-5 { background-color: #e0f2fe; }

        .time-display { background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 12px; font-weight: bold; font-size: 24px; white-space: nowrap; text-align: center; }
        .title-selector { background-color: #f1f5f9; border-radius: 10px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .title-chips-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex: 1; }
        .title-chip { background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; user-select: none; transition: all 0.2s; font-weight: 500; font-size: 16px; white-space: nowrap; }
        .title-chip:hover { background-color: #2563eb; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .title-chip.dragging { opacity: 0.5; }
        .frame-header { display: flex; align-items: center; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .frame-title-input { width: 160px; font-size: 24px; font-weight: bold; padding: 4px 8px; border: 2px solid rgba(0,0,0,0.1); border-radius: 6px; background-color: rgba(255,255,255,0.9); }
        .frame-button { padding: 6px 10px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .frame-button-select { background-color: #3b82f6; color: white; }
        .frame-button-select:hover { background-color: #2563eb; }
        .frame-button-deselect { background-color: #6b7280; color: white; }
        .frame-button-deselect:hover { background-color: #4b5563; }
        
        .add-title-inline { display: flex; align-items: center; gap: 8px; }
        .add-title-input { font-size: 16px; padding: 6px 12px; border: 2px solid #fbbf24; border-radius: 6px; width: 140px; }
        .add-title-btn { font-size: 14px; padding: 6px 12px; background-color: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .add-title-btn:hover { background-color: #d97706; }

        .frames-container { position: relative; }
        .center-time-wrapper { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; pointer-events: none; }
        @media (min-width: 768px) { .center-time-wrapper { display: block; } }

        @media print {
            body { overflow: auto; background: white; }
            header, .no-print { display: none !important; }
            .print-visible { display: block !important; }
            .content-area { height: auto; overflow: visible; }
            #homework-grid { display: grid; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
 
    <!-- 頂部導覽列 -->
    <header class="h-[60px] bg-white border-b shadow-sm flex items-center px-4 justify-between shrink-0 z-10">
        <div class="flex items-center h-full pt-2 max-w-[70%]">
            <div class="flex items-center space-x-1 overflow-x-auto no-scrollbar h-full" id="tabs-container"></div>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-500 flex items-center mr-2 font-bold bg-gray-100 px-2 py-1 rounded-full">
                 <i class="fas fa-circle-notch fa-spin mr-1"></i> 系統啟動中...
            </div>
        </div>
    </header>
 
    <!-- 主要內容區 -->
    <main class="flex-grow relative bg-gray-100 flex flex-col overflow-hidden" id="main-content"></main>
 
    <!-- ================= 模板區域 ================= -->
    <div style="display:none;">
       
        <!-- 1. 首頁黑板模板 -->
        <div id="template-home">
             <div class="grid grid-cols-12 gap-4 h-full p-4 content-area">
                 <div class="col-span-12 md:col-span-3 flex flex-col gap-4 h-full">
                      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500 shrink-0">
                          <div class="flex items-end justify-between">
                              <div>
                                  <div id="clock-time" class="text-4xl font-mono font-bold text-gray-800 tracking-wider">00:00:00</div>
                                  <div id="clock-date" class="text-lg text-gray-500 mt-1 font-medium">Loading...</div>
                              </div>
                              <div class="text-3xl text-blue-500"><i class="far fa-clock"></i></div>
                          </div>
                      </div>
                      <div class="duty-card p-3 shrink-0">
                          <h3 class="font-bold text-blue-800 text-lg mb-2 flex items-center"><i class="fas fa-user-friends mr-2"></i>今日值日生</h3>
                          <div class="flex gap-2 items-center">
                              <div class="flex-1"><input type="number" id="duty-1" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                              <span class="text-blue-400 font-bold">&</span>
                              <div class="flex-1"><input type="number" id="duty-2" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                          </div>
                      </div>
                      <div class="sticky-note flex-grow flex flex-col p-4 relative min-h-0">
                          <div class="flex justify-between items-center mb-2 border-b border-yellow-400 pb-2 shrink-0">
                              <h3 class="font-bold text-gray-700 text-xl"><i class="fas fa-bullhorn mr-2"></i>老師叮嚀</h3>
                              <div class="flex gap-1 items-center bg-white/50 p-1 rounded">
                                  <button onclick="app.adjustFontSize(-2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-minus"></i></button>
                                  <button onclick="app.adjustFontSize(2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-plus"></i></button>
                                  <div class="w-px h-4 bg-gray-400 mx-1"></div>
                                  <input type="color" id="reminder-color" oninput="app.updateReminderStyle()" value="#000000" class="w-5 h-5 cursor-pointer border-0 p-0 rounded bg-transparent">
                                  <button id="blink-toggle" onclick="app.toggleBlink()" class="text-gray-400 hover:text-red-500 transition px-1"><i class="fas fa-bolt"></i></button>
                              </div>
                          </div>
                          <textarea id="reminder-text" oninput="app.saveSettings()" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 leading-relaxed" placeholder="在這裡輸入給全班的提醒事項..." style="font-size: 24px;"></textarea>
                      </div>
                 </div>
                 <div class="col-span-12 md:col-span-9 h-full flex flex-col">
                      <div class="blackboard h-full p-6 flex flex-col relative">
                          <div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-600 pb-2 shrink-0">
                              <div class="flex items-center gap-4">
                                  <h2 class="text-3xl font-bold text-white tracking-widest"><i class="fas fa-book-open mr-2"></i>聯絡簿</h2>
                                  <span id="board-date-display" class="text-2xl text-yellow-300 font-mono">--/-- (一)</span>
                              </div>
                              <div class="flex gap-4 items-center">
                                  <div class="flex gap-1 bg-white/10 rounded px-2 py-1 items-center">
                                      <button onclick="app.changeContactBookFontSize(-2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>-</button>
                                      <span class="text-xs text-gray-300">字體</span>
                                      <button onclick="app.changeContactBookFontSize(2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>+</button>
                                  </div>
                                  <div class="flex gap-2">
                                      <button onclick="app.changeWeek(-1)" class="text-gray-300 hover:text-white px-2 py-1 border border-gray-500 rounded hover:bg-white/10 text-sm">上週</button>
                                      <button onclick="app.changeWeek(1)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded shadow font-bold text-sm"><i class="fas fa-calendar-check mr-1"></i>新的一週</button>
                                  </div>
                              </div>
                          </div>
                          <div class="flex gap-1 mb-2 overflow-x-auto shrink-0">
                              <button onclick="app.switchDay(0)" id="day-btn-0" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週一</button>
                              <button onclick="app.switchDay(1)" id="day-btn-1" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週二</button>
                              <button onclick="app.switchDay(2)" id="day-btn-2" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週三</button>
                              <button onclick="app.switchDay(3)" id="day-btn-3" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週四</button>
                              <button onclick="app.switchDay(4)" id="day-btn-4" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週五</button>
                          </div>
                          <div class="flex-grow flex gap-6 overflow-hidden pt-2">
                              <div class="flex-grow flex flex-col overflow-y-auto pr-2 w-7/12" id="todo-list-container">
                                  <div id="todo-list" class="space-y-3 mb-2"></div>
                                  <div class="mb-4">
                                      <button onclick="app.addTodoItem()" class="text-yellow-400 hover:text-yellow-200 text-sm border border-dashed border-yellow-600 hover:border-yellow-400 px-3 py-1 rounded transition flex items-center"><i class="fas fa-plus mr-1"></i> 新增項目</button>
                                  </div>
                              </div>
                              <div class="w-px bg-white/10 border-l border-dashed border-gray-500/50"></div>
                              <div class="w-5/12 flex flex-col gap-2 min-w-[200px]">
                                  <div class="bg-black/20 rounded p-2 text-center relative">
                                      <label class="block text-yellow-300 text-lg mb-1 font-bold">今日成語</label>
                                      <div class="absolute top-2 right-2 flex gap-1 z-10">
                                           <button onclick="app.changeIdiomFontSize(-2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-minus"></i></button>
                                           <button onclick="app.changeIdiomFontSize(2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-plus"></i></button>
                                      </div>
                                      <input type="text" id="idiom-input" oninput="app.saveContactBook()" class="chalk-input text-2xl text-center font-bold text-yellow-100 w-full" placeholder="輸入成語">
                                  </div>
                                  <textarea id="idiom-desc" oninput="app.saveContactBook()" class="chalk-input text-xl text-gray-200 resize-none flex-grow p-2" placeholder="在此輸入解釋或例句..."></textarea>
                              </div>
                          </div>
                      </div>
                 </div>
             </div>
        </div>
 
        <!-- 2. 作業管理模板 -->
        <div id="template-homework" class="w-full h-full workbook-bg">
            <div class="flex flex-col h-full ml-0">
                 <div class="p-2 md:p-3 flex flex-wrap items-center justify-between gap-2 shrink-0 no-print bg-white/80 backdrop-blur border-b border-green-100 m-2 rounded-xl shadow-sm">
                      <div class="flex items-center gap-2">
                        <div class="bg-green-500 text-white p-2 rounded-full shadow"><i class="fas fa-book text-lg"></i></div>
                        <h2 class="text-lg md:text-xl font-bold text-slate-700 cute-font">作業繳交紀錄簿</h2>
                      </div>
                      <div class="flex flex-wrap items-center gap-2 md:gap-3">
                          <div class="flex items-center gap-2 bg-white px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-green-200 shadow-inner">
                              <i class="fas fa-calendar-alt text-green-500"></i>
                              <input type="date" id="homework-date" onchange="app.changeHomeworkDate(this.value)" class="bg-transparent border-none outline-none font-bold text-slate-600 text-sm cursor-pointer cute-font">
                          </div>
                          <div class="flex items-center gap-1 bg-red-50 px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-red-100">
                               <span class="text-sm font-bold text-red-400">待補:</span><span id="pending-count-badge" class="text-base font-black text-red-500 cute-font">0</span>
                          </div>
                          <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 text-sm font-bold shadow"><i class="fas fa-print"></i></button>
                      </div>
                 </div>
                 <div class="flex-grow p-2 md:p-4 overflow-y-auto scrollable-content" id="homework-scroll-area">
                      <div class="mb-3 flex flex-wrap gap-2 items-center bg-white/80 p-2 rounded-xl border border-green-100 no-print shadow-sm">
                          <span class="text-sm font-bold text-slate-500 cute-font">快速新增：</span>
                          <input type="text" id="new-hw-type" placeholder="項目名稱" class="border border-green-200 rounded-full px-3 py-1 text-sm focus:outline-none focus:border-green-400 w-28 md:w-32 bg-white">
                          <button onclick="app.addHomeworkType()" class="bg-green-500 text-white hover:bg-green-600 px-3 py-1 rounded-full text-sm font-bold transition shadow-sm"><i class="fas fa-plus"></i></button>
                      </div>
                      <div id="homework-grid" class="grid grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-2 md:gap-3 pb-4"></div>
                 </div>
            </div>
        </div>

        <!-- 3. 訂正系統模板 (整合版) -->
        <div id="template-correction" class="w-full h-full overflow-y-auto">
             <div class="correction-wrapper max-w-7xl mx-auto">
                <div class="title-selector mb-8">
                    <div class="title-chips-container" id="titleChipsContainer"></div>
                    <div class="add-title-inline">
                        <input type="text" id="customTitleInput" class="add-title-input" placeholder="新增標題..."> 
                        <button onclick="app.correction.addCustomTitle()" class="add-title-btn">新增</button>
                    </div>
                </div>
                <div class="frames-container">
                    <div class="center-time-wrapper">
                        <div id="centerTimeDisplay" class="time-display"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="frames-grid"></div>
                </div>
            </div>
        </div>
    </div>
 
    <!-- 新增/修改滿版分頁 Modal -->
    <div id="add-tab-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 flex flex-col max-h-[90vh]">
            <h3 id="modal-title" class="text-2xl font-bold text-blue-900 mb-2 border-b-2 border-blue-100 pb-2 flex items-center">
                 <i class="fas fa-code mr-2 text-blue-500"></i> 新增自訂分頁
            </h3>
            <p class="text-sm text-blue-700 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                 <i class="fas fa-shield-alt text-green-600 mr-1"></i> <strong>已啟用沙盒隔離技術</strong><br>
                 您可以貼上 AI 生成的完整 HTML 代碼、任何網址，系統會自動建立獨立環境運行。
            </p>
           
            <div class="mb-4">
                 <label class="block text-gray-700 font-bold mb-2">1. 分頁名稱</label>
                 <input type="text" id="new-tab-title" class="w-full border-2 border-gray-200 focus:border-blue-400 p-2 rounded outline-none transition" placeholder="例如：訂正小工具">
            </div>
            <div class="mb-6 flex-grow flex flex-col">
                <label class="block text-gray-700 font-bold mb-2">2. 貼上 HTML 原始碼 或 直接貼網址</label>
                 <textarea id="new-tab-code" class="w-full border-2 border-gray-200 focus:border-blue-400 p-2 rounded outline-none transition flex-grow resize-none font-mono text-sm h-32" placeholder='請貼上完整 HTML 原始碼、網址或 <iframe ...> 語法'></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t border-gray-100">
                 <button onclick="app.closeAddTabModal()" class="px-5 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">取消</button>
                 <button id="modal-submit-btn" onclick="app.confirmAddOrEditTab()" class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition"><i class="fas fa-save mr-1"></i> 儲存分頁</button>
            </div>
        </div>
    </div>
 
    <!-- 作業勾選 Modal -->
    <div id="homework-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-green-500 text-white p-6 flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <span class="text-green-100 text-sm font-medium uppercase tracking-wider">學生座號</span>
                    <div class="text-5xl font-black leading-none cute-font" id="modal-student-id">--</div>
                </div>
                <button onclick="app.closeHomeworkModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors relative z-10"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-green-50 flex-grow">
                 <div id="homework-types-grid" class="grid grid-cols-2 gap-3"></div>
            </div>
            <div class="p-4 bg-white border-t border-green-100 flex justify-between items-center shrink-0">
                 <button onclick="app.markAllResolved()" class="flex items-center gap-2 text-green-600 font-bold hover:bg-green-50 px-4 py-2 rounded-lg transition-colors"><i class="fas fa-check-circle"></i>全部補交</button>
                 <button onclick="app.closeHomeworkModal()" class="bg-slate-700 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-800 transition-colors shadow-lg">完成</button>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div id="notification" class="notification"></div>
 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 
        // 您的 Firebase 金鑰
        const firebaseConfig = {
            apiKey: "AIzaSyAT9VXm8gf5Pn4A1iu3xXF6X8Ve9NYlUAk", 
            authDomain: "teacherboard-9224d.firebaseapp.com",
            projectId: "teacherboard-9224d",
            storageBucket: "teacherboard-9224d.firebasestorage.app",
            messagingSenderId: "801036213120",
            appId: "1:801036213120:web:2077de68b0a74395023f65"
        };
 
        let db, docRef;
 
        window.app = {
            tabs: [ 
                { id: 'home', title: '聯絡簿', type: 'system', icon: 'fa-home' }, 
                { id: 'homework', title: '作業管理', type: 'system', icon: 'fa-book' },
                { id: 'correction', title: '訂正系統', type: 'system', icon: 'fa-check-square' } 
            ],
            settings: { 
                reminderText: '', reminderColor: '#000000', reminderFontSize: 24, reminderBlink: false, 
                duty1: '', duty2: '', contactBookFontSize: 24, idiomFontSize: 24, 
                homeworkTypes: ["生字", "圈短", "短造", "國習", "聽考", "國卷", "數習", "數作", "數卷", "數八", "作文", "聯絡簿", "回條", "週記"] 
            },
            data: { 
                contactBook: {}, 
                homework: {}, 
                memos: {}, 
                customTabs: [], 
                // 訂正系統的資料結構 (預設值)
                correction: {
                    selectedNumbers: Array(6).fill().map(()=>[]),
                    correctionTitles: Array(6).fill(''),
                    defaultTitles: ['生字','圈短','短造','國習','數習','數作','數卷','國卷','聯絡簿','刷牙擦桌子','聽考','社習','作文','週記','數八','英單','數課']
                }
            },
           
            saveTimeout: null, 
            activeTabId: 'home', 
            currentWeekBase: null,
            currentDayIndex: 0, 
            currentHomeworkDate: new Date().toISOString().split('T')[0], 
            currentEditingStudent: null,
           
            init: function() {
                this.currentWeekBase = this.getMonday(new Date());
                const day = new Date().getDay();
                this.currentDayIndex = (day === 0 || day === 6) ? 0 : day - 1;
                this.renderTabs();
                this.switchTab('home');
                this.startClock();
                if(document.getElementById('homework-date')) {
                    document.getElementById('homework-date').value = this.currentHomeworkDate;
                }
 
                const statusEl = document.getElementById('sync-status');
                
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    docRef = doc(db, "Classrooms", "TeacherBoard_Data");
                    this.setupRealtimeListener();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    if(statusEl) statusEl.innerHTML = '<span class="text-red-500">連線設定錯誤</span>';
                }
            },
 
            getMonday: function(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },
 
            setupRealtimeListener: function() {
                const statusEl = document.getElementById('sync-status');
                if(statusEl) statusEl.innerHTML = '<i class="fas fa-cloud-download-alt animate-bounce mr-1"></i> 連線中...';
 
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const parsed = docSnap.data();
                        
                        if (parsed.settings) this.settings = { ...this.settings, ...parsed.settings };
                        if (parsed.data) {
                            let loadedData = parsed.data;
                            // 解壓縮字串化的資料
                            if (typeof loadedData.correction === 'string') {
                                try { loadedData.correction = JSON.parse(loadedData.correction); } catch(e) {}
                            }
                            this.data = { ...this.data, ...loadedData };
                            
                            if (!this.data.correction) this.data.correction = {};
                            if (!this.data.correction.selectedNumbers) this.data.correction.selectedNumbers = Array(6).fill().map(()=>[]);
                            if (!this.data.correction.correctionTitles) this.data.correction.correctionTitles = Array(6).fill('');
                            if (!this.data.correction.defaultTitles) this.data.correction.defaultTitles = ['生字','圈短','短造','國習','數習','數作','數卷','國卷','聯絡簿','刷牙擦桌子','聽考','社習','作文','週記','數八','英單','數課'];
                        }
                        
                        // 根據當前分頁刷新 UI
                        if (this.activeTabId === 'home') this.initHomeView();
                        else if (this.activeTabId === 'homework') this.renderHomeworkGrid();
                        else if (this.activeTabId === 'correction') this.correction.render();
                        else this.renderCustomTabView(this.activeTabId);
                        
                        if(statusEl) {
                            statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> 雲端同步完成';
                        }
                    } else {
                        // 第一次使用，建立空文件
                        this.saveToCloud();
                    }
                }, (error) => {
                    console.error("監聽失敗:", error);
                    if(statusEl) statusEl.innerHTML = '<span class="text-red-500">連線中斷</span>';
                });
            },
 
            saveToCloud: function() {
                if (!docRef) return;
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.className = "text-xs text-blue-600 flex items-center mr-2 font-bold bg-blue-50 px-2 py-1 rounded-full";
                    statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> 上傳中...';
                }
 
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(async () => {
                    try {
                        // 處理 Nested Array 問題
                        const dataToSave = JSON.parse(JSON.stringify(this.data));
                        if (dataToSave.correction && Array.isArray(dataToSave.correction.selectedNumbers)) {
                            // 將訂正資料轉為字串
                            dataToSave.correction = JSON.stringify(dataToSave.correction);
                        }

                        await setDoc(docRef, { settings: this.settings, data: dataToSave }, { merge: true });
                        if (statusEl) {
                             statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                             statusEl.innerHTML = '<i class="fas fa-cloud-upload-alt mr-1"></i> 已儲存至雲端';
                        }
                    } catch (e) {
                        console.error("儲存失敗:", e);
                        if (statusEl) statusEl.innerHTML = '<span class="text-red-500">儲存失敗: ' + e.message + '</span>';
                    }
                }, 800);
            },
 
            renderTabs: function() {
                const container = document.getElementById('tabs-container');
                if(!container) return;
                container.innerHTML = '';
                this.tabs.forEach(tab => {
                    const el = document.createElement('div');
                    el.className = `tab-btn ${tab.id === this.activeTabId ? 'tab-active' : 'tab-inactive'}`;
                    el.onclick = () => this.switchTab(tab.id);
                    el.innerHTML = `<i class="fas ${tab.icon} mr-2"></i><span>${tab.title}</span>`;
                    container.appendChild(el);
                });
                
                // 渲染自訂分頁 (如果有)
                if (Array.isArray(this.data.customTabs)) {
                    this.data.customTabs.forEach(tab => this.createTabElement(container, tab, true));
                }
            },
           
            createTabElement: function(container, tab, isCustom) {
                const el = document.createElement('div');
                el.className = `tab-btn ${tab.id === this.activeTabId ? 'tab-active' : 'tab-inactive'}`;
                el.onclick = () => this.switchTab(tab.id);
                
                const iconClass = isCustom ? 'fa-globe' : (tab.icon || 'fa-folder-open');
                el.innerHTML = `<i class="fas ${iconClass} mr-2"></i><span>${tab.title}</span>`;
                
                if (isCustom) {
                    const editBtn = document.createElement('div');
                    editBtn.className = 'tab-edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                    editBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); app.openEditTabModal(tab.id); });
                    el.appendChild(editBtn);

                    const delBtn = document.createElement('div');
                    delBtn.className = 'tab-edit-btn hover:bg-red-500';
                    delBtn.style.marginLeft = '4px';
                    delBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                    delBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); app.deleteTab(tab.id); });
                    el.appendChild(delBtn);
                }
                
                container.appendChild(el);
            },
 
            switchTab: function(tabId) {
                this.activeTabId = tabId;
                this.renderTabs();
                const main = document.getElementById('main-content');
                main.innerHTML = '';
                
                if (tabId === 'home') {
                    main.appendChild(document.getElementById('template-home').firstElementChild.cloneNode(true));
                    this.initHomeView();
                } else if (tabId === 'homework') {
                    main.appendChild(document.getElementById('template-homework').firstElementChild.cloneNode(true));
                    const dateInput = document.getElementById('homework-date');
                    if(dateInput) dateInput.value = this.currentHomeworkDate;
                    this.renderHomeworkGrid();
                } else if (tabId === 'correction') {
                    main.appendChild(document.getElementById('template-correction').firstElementChild.cloneNode(true));
                    this.correction.init();
                } else {
                    const tabData = this.data.customTabs.find(t => t.id === tabId);
                    if (tabData) this.renderCustomTabView(tabData);
                }
            },
            
            // 渲染使用者自訂分頁 (Sandboxed)
            renderCustomTabView: function(tabData) {
                if (!tabData) return;
                const main = document.getElementById('main-content');
                const container = document.createElement('div');
                container.className = "w-full h-full bg-white flex flex-col";
                
                let contentHTML = '';
                const code = tabData.content;
                
                if (code.trim().startsWith('http')) {
                     contentHTML = `<iframe src="${code}" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>`;
                } else if (code.includes('<iframe')) {
                     contentHTML = `<div class="w-full h-full flex items-center justify-center bg-black">${code.replace('<iframe', '<iframe class="w-full h-full"')}</div>`;
                } else {
                     contentHTML = `<iframe srcdoc="${code.replace(/"/g, '&quot;')}" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>`;
                }
                
                container.innerHTML = contentHTML;
                main.appendChild(container);
            },

            // ================= 訂正系統邏輯 (整合版) =================
            correction: {
                init: function() {
                    this.createFrames();
                    this.createTitleChips();
                    this.render();
                    
                    const customInput = document.getElementById('customTitleInput');
                    if(customInput) {
                        const newElement = customInput.cloneNode(true);
                        customInput.parentNode.replaceChild(newElement, customInput);
                        newElement.addEventListener('keypress', e => {
                            if(e.key === 'Enter') app.correction.addCustomTitle();
                        });
                    }
                    
                    const timeEl = document.getElementById('centerTimeDisplay');
                    if(timeEl) {
                        const updateCorrectClock = () => {
                            const d=new Date();
                            timeEl.textContent=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
                        };
                        updateCorrectClock();
                        if(this.timer) clearInterval(this.timer);
                        this.timer = setInterval(updateCorrectClock, 1000);
                    }
                },
                
                createFrames: function() {
                    const grid = document.getElementById('frames-grid');
                    if(!grid) return;
                    grid.innerHTML = '';
                    
                    for(let i=0; i<6; i++) {
                        const frame = document.createElement('div');
                        frame.id = `frame-${i}`;
                        frame.className = `corr-frame frame-bg-${i}`;
                        frame.innerHTML = `
                            <div class="frame-header">
                                <input type="text" class="frame-title-input" placeholder="訂正項目" data-frame-index="${i}">
                                <button onclick="app.correction.selectAll(${i})" class="frame-button frame-button-select">全選</button>
                                <button onclick="app.correction.deselectAll(${i})" class="frame-button frame-button-deselect">取消</button>
                            </div>
                            <div class="corr-number-grid" id="grid-${i}"></div>
                        `;
                        frame.querySelector('.frame-title-input').oninput = e => app.correction.updateTitle(i, e.target.value);
                        grid.appendChild(frame);
                        
                        const numGrid = frame.querySelector(`#grid-${i}`);
                        for(let n=1; n<=29; n++) {
                            if(n===15) continue;
                            const item = document.createElement('div');
                            item.className = 'corr-number-item';
                            item.textContent = n;
                            item.dataset.number = n;
                            item.onclick = () => app.correction.toggleNumber(i, n);
                            numGrid.appendChild(item);
                        }
                    }
                },
                
                render: function() {
                    const data = app.data.correction;
                    if(!data) return;

                    document.querySelectorAll('.frame-title-input').forEach((input, i) => {
                        input.value = data.correctionTitles[i] || '';
                    });
                    
                    for(let f=0; f<6; f++) {
                        const frame = document.getElementById(`grid-${f}`);
                        if(frame) {
                            frame.querySelectorAll('.corr-number-item').forEach(item => {
                                const n = parseInt(item.dataset.number);
                                if (data.selectedNumbers[f] && data.selectedNumbers[f].includes(n)) {
                                    item.classList.add('selected');
                                } else {
                                    item.classList.remove('selected');
                                }
                            });
                        }
                    }
                    this.createTitleChips();
                },
                
                createTitleChips: function() {
                    const container = document.getElementById('titleChipsContainer');
                    if(!container) return;
                    container.innerHTML = '';
                    
                    const titles = app.data.correction.defaultTitles || [];
                    titles.forEach((title, index) => {
                        const chip = document.createElement('div');
                        chip.className = 'title-chip';
                        chip.textContent = title;
                        chip.draggable = true;
                        
                        chip.onclick = () => {
                            const input = document.querySelector('.frame-title-input:focus');
                            if(input) {
                                const f = parseInt(input.dataset.frameIndex);
                                input.value = title;
                                app.correction.updateTitle(f, title);
                            }
                        };
                        
                        chip.oncontextmenu = (e) => {
                            e.preventDefault();
                            if(index >= 17) { // 預設標題不可刪
                                if(confirm(`確定要刪除標題「${title}」嗎？`)) {
                                    app.data.correction.defaultTitles.splice(index, 1);
                                    app.saveToCloud();
                                    app.correction.createTitleChips();
                                }
                            }
                        };
                        
                        chip.ondragstart = (e) => e.dataTransfer.setData('text/plain', title);
                        container.appendChild(chip);
                    });
                },
                
                toggleNumber: function(frameIdx, num) {
                    const list = app.data.correction.selectedNumbers[frameIdx];
                    const idx = list.indexOf(num);
                    if(idx > -1) list.splice(idx, 1);
                    else list.push(num);
                    app.saveToCloud();
                    this.render();
                },
                
                selectAll: function(frameIdx) {
                    app.data.correction.selectedNumbers[frameIdx] = [];
                    for(let i=1; i<=29; i++) {
                        if(i!==15) app.data.correction.selectedNumbers[frameIdx].push(i);
                    }
                    app.saveToCloud();
                    this.render();
                },
                
                deselectAll: function(frameIdx) {
                    app.data.correction.selectedNumbers[frameIdx] = [];
                    app.saveToCloud();
                    this.render();
                },
                
                updateTitle: function(frameIdx, val) {
                    app.data.correction.correctionTitles[frameIdx] = val;
                    app.saveToCloud();
                },
                
                addCustomTitle: function() {
                    const input = document.getElementById('customTitleInput');
                    const val = input.value.trim();
                    if(val) {
                        if(!app.data.correction.defaultTitles.includes(val)) {
                            app.data.correction.defaultTitles.push(val);
                            app.saveToCloud();
                            this.createTitleChips();
                        }
                        input.value = '';
                    }
                },
                
                showNotification: function(m) {
                    const n = document.getElementById('notification');
                    if(n) {
                        n.textContent = m;
                        n.style.display = 'block';
                        setTimeout(() => n.style.display = 'none', 3000);
                    }
                }
            },

            // ================= 首頁邏輯 =================

            initHomeView: function() {
                const sets = this.settings;
                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                
                setVal('duty-1', sets.duty1);
                setVal('duty-2', sets.duty2);
                setVal('reminder-text', sets.reminderText);
                setVal('reminder-color', sets.reminderColor || '#000000');
                
                const rText = document.getElementById('reminder-text');
                if(rText) {
                    rText.style.color = sets.reminderColor;
                    rText.style.fontSize = (sets.reminderFontSize || 24) + 'px';
                    if (sets.reminderBlink) rText.classList.add('blink-active');
                }

                this.updateDateDisplay();
                this.updateDayButtons();
                this.renderTodoList();
                this.renderIdiom();
            },

            startClock: function() {
                const update = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
                    const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                    const timeEl = document.getElementById('clock-time');
                    const dateEl = document.getElementById('clock-date');
                    if(timeEl) timeEl.innerText = timeStr;
                    if(dateEl) dateEl.innerText = dateStr;
                };
                update();
                setInterval(update, 1000);
            },

            getMonday: function(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },

            updateDateDisplay: function() {
                if(!this.currentWeekBase) return;
                const targetDate = new Date(this.currentWeekBase);
                targetDate.setDate(targetDate.getDate() + this.currentDayIndex);
                const display = document.getElementById('board-date-display');
                const weekNames = ['(日)', '(一)', '(二)', '(三)', '(四)', '(五)', '(六)'];
                if(display) {
                    display.innerText = `${targetDate.getMonth()+1}/${targetDate.getDate()} ${weekNames[targetDate.getDay()]}`;
                }
            },
            
            changeWeek: function(offset) {
                this.currentWeekBase.setDate(this.currentWeekBase.getDate() + (offset * 7));
                this.updateDateDisplay();
                this.renderTodoList();
                this.renderIdiom();
            },

            switchDay: function(idx) {
                this.currentDayIndex = idx;
                this.updateDayButtons();
                this.updateDateDisplay();
                this.renderTodoList();
                this.renderIdiom();
            },

            updateDayButtons: function() {
                for(let i=0; i<5; i++) {
                    const btn = document.getElementById(`day-btn-${i}`);
                    if(!btn) continue;
                    if(i === this.currentDayIndex) {
                        btn.className = "day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-yellow-600 text-white shadow-lg transform -translate-y-1";
                    } else {
                        btn.className = "day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20";
                    }
                }
            },

            getDateKey: function() {
                const d = new Date(this.currentWeekBase);
                d.setDate(d.getDate() + this.currentDayIndex);
                return d.toISOString().split('T')[0];
            },

            renderTodoList: function() {
                const listEl = document.getElementById('todo-list');
                if(!listEl) return;
                listEl.innerHTML = '';
                
                const dateKey = this.getDateKey();
                const items = (this.data.contactBook && this.data.contactBook[dateKey]) ? this.data.contactBook[dateKey].items : [];
                
                items.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "group flex items-center bg-white/10 p-2 rounded hover:bg-white/20 transition";
                    div.innerHTML = `
                        <div class="text-yellow-400 font-bold mr-3 text-xl w-6 text-center">${idx + 1}.</div>
                        <input type="text" class="chalk-input text-xl flex-grow ${item.done ? 'line-through text-gray-400' : ''}" 
                            value="${item.text}" oninput="app.updateTodoText(${idx}, this.value)" 
                            style="font-size: ${this.settings.contactBookFontSize || 24}px">
                        <i class="fas fa-trash-alt cb-delete-btn" onclick="app.removeTodoItem(${idx})"></i>
                    `;
                    listEl.appendChild(div);
                });
            },

            addTodoItem: function() {
                const dateKey = this.getDateKey();
                if (!this.data.contactBook) this.data.contactBook = {};
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { items: [], idiom: '', idiomDesc: '' };
                
                this.data.contactBook[dateKey].items.push({ text: '', done: false });
                this.renderTodoList();
                this.saveToCloud();
            },

            removeTodoItem: function(idx) {
                const dateKey = this.getDateKey();
                if (this.data.contactBook[dateKey]) {
                    this.data.contactBook[dateKey].items.splice(idx, 1);
                    this.renderTodoList();
                    this.saveToCloud();
                }
            },

            updateTodoText: function(idx, val) {
                const dateKey = this.getDateKey();
                if (this.data.contactBook[dateKey]) {
                    this.data.contactBook[dateKey].items[idx].text = val;
                    this.saveToCloud();
                }
            },

            changeContactBookFontSize: function(delta) {
                let size = (this.settings.contactBookFontSize || 24) + delta;
                if(size < 12) size = 12;
                if(size > 48) size = 48;
                this.settings.contactBookFontSize = size;
                this.renderTodoList();
                this.saveSettings();
            },

            renderIdiom: function() {
                const dateKey = this.getDateKey();
                const data = (this.data.contactBook && this.data.contactBook[dateKey]) || { idiom: '', idiomDesc: '' };
                const iInput = document.getElementById('idiom-input');
                const iDesc = document.getElementById('idiom-desc');
                
                if(iInput) {
                    iInput.value = data.idiom || '';
                    iInput.style.fontSize = (this.settings.idiomFontSize || 24) + 'px';
                }
                if(iDesc) {
                    iDesc.value = data.idiomDesc || '';
                    iDesc.style.fontSize = (this.settings.idiomFontSize || 24) * 0.8 + 'px';
                }
            },

            saveContactBook: function() {
                const dateKey = this.getDateKey();
                const iInput = document.getElementById('idiom-input');
                const iDesc = document.getElementById('idiom-desc');
                
                if (!this.data.contactBook) this.data.contactBook = {};
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { items: [], idiom: '', idiomDesc: '' };
                
                this.data.contactBook[dateKey].idiom = iInput ? iInput.value : '';
                this.data.contactBook[dateKey].idiomDesc = iDesc ? iDesc.value : '';
                this.saveToCloud();
            },
            
            changeIdiomFontSize: function(delta) {
                 let size = (this.settings.idiomFontSize || 24) + delta;
                 if(size < 12) size = 12;
                 if(size > 60) size = 60;
                 this.settings.idiomFontSize = size;
                 this.renderIdiom();
                 this.saveSettings();
            },

            saveSettings: function() {
                this.settings.duty1 = document.getElementById('duty-1').value;
                this.settings.duty2 = document.getElementById('duty-2').value;
                this.settings.reminderText = document.getElementById('reminder-text').value;
                this.saveToCloud();
            },
            
            updateReminderStyle: function() {
                const color = document.getElementById('reminder-color').value;
                this.settings.reminderColor = color;
                const rText = document.getElementById('reminder-text');
                if(rText) rText.style.color = color;
                this.saveToCloud();
            },
            
            adjustFontSize: function(delta) {
                let current = this.settings.reminderFontSize || 24;
                current += delta;
                if(current < 12) current = 12;
                this.settings.reminderFontSize = current;
                const rText = document.getElementById('reminder-text');
                if(rText) rText.style.fontSize = current + 'px';
                this.saveToCloud();
            },

            toggleBlink: function() {
                this.settings.reminderBlink = !this.settings.reminderBlink;
                const rText = document.getElementById('reminder-text');
                if(rText) {
                    if(this.settings.reminderBlink) rText.classList.add('blink-active');
                    else rText.classList.remove('blink-active');
                }
                this.saveToCloud();
            },

            // ================= 作業管理邏輯 =================

            changeHomeworkDate: function(date) {
                this.currentHomeworkDate = date;
                this.renderHomeworkGrid();
            },
            
            addHomeworkType: function() {
                const input = document.getElementById('new-hw-type');
                const val = input.value.trim();
                if(val && !this.settings.homeworkTypes.includes(val)) {
                    this.settings.homeworkTypes.push(val);
                    input.value = '';
                    this.saveToCloud();
                    this.renderHomeworkGrid();
                    alert(`已新增作業項目：${val}`);
                }
            },

            renderHomeworkGrid: function() {
                const grid = document.getElementById('homework-grid');
                if(!grid) return;
                grid.innerHTML = '';
                
                let pendingTotal = 0;
                
                for (let i = 1; i <= 30; i++) {
                    const studentId = i.toString();
                    const dayData = (this.data.homework && this.data.homework[this.currentHomeworkDate]) || {};
                    const studentData = dayData[studentId] || {}; 
                    
                    const missingItems = Object.keys(studentData).filter(key => studentData[key] === 'missing');
                    const resolvedItems = Object.keys(studentData).filter(key => studentData[key] === 'resolved');

                    const isComplete = missingItems.length === 0;
                    
                    if (!isComplete) pendingTotal++;

                    const cell = document.createElement('div');
                    cell.className = `student-grid-cell ${isComplete ? '' : 'incomplete'}`;
                    cell.onclick = () => this.openHomeworkModal(studentId);
                    
                    let statusHTML = '';
                    if (isComplete) {
                        if(resolvedItems.length > 0) {
                             statusHTML = `<div class="flex-grow flex items-center justify-center text-green-500 text-4xl opacity-80"><i class="fas fa-check-double"></i></div>`;
                        } else {
                             statusHTML = `<div class="flex-grow flex items-center justify-center text-green-100 text-4xl opacity-20"><i class="fas fa-check"></i></div>`;
                        }
                    } else {
                        statusHTML = `<div class="flex-grow flex flex-col items-center justify-center p-1 gap-1 overflow-hidden">
                            ${missingItems.map(t => `<span class="text-xs bg-red-100 text-red-600 px-1 rounded truncate w-full text-center font-bold">${t}</span>`).join('')}
                        </div>`;
                    }

                    cell.innerHTML = `
                        <div class="cell-tape"></div>
                        <div class="mt-3 text-center font-black text-xl text-gray-700 cute-font z-10">${studentId}</div>
                        ${statusHTML}
                    `;
                    grid.appendChild(cell);
                }
                
                const badge = document.getElementById('pending-count-badge');
                if(badge) badge.innerText = pendingTotal;
            },

            openHomeworkModal: function(studentId) {
                this.currentEditingStudent = studentId;
                document.getElementById('modal-student-id').innerText = studentId;
                
                const grid = document.getElementById('homework-types-grid');
                grid.innerHTML = '';
                
                const dayData = (this.data.homework && this.data.homework[this.currentHomeworkDate]) || {};
                const studentData = dayData[studentId] || {};
                
                this.settings.homeworkTypes.forEach(type => {
                    const status = studentData[type] || 'none';
                    
                    const btn = document.createElement('button');
                    let btnClass = "p-3 rounded-lg font-bold text-lg transition flex justify-between items-center shadow-sm ";
                    let iconHTML = "";
                    
                    if (status === 'missing') {
                        btnClass += "bg-red-500 text-white shadow-lg transform scale-105 ring-2 ring-red-300";
                        iconHTML = '<i class="fas fa-times-circle text-white text-xl"></i>';
                    } else if (status === 'resolved') {
                        btnClass += "bg-green-500 text-white shadow-md ring-2 ring-green-300";
                        iconHTML = '<i class="fas fa-check-circle text-white text-xl"></i>';
                    } else {
                        btnClass += "bg-gray-100 text-gray-500 hover:bg-gray-200";
                        iconHTML = '<i class="far fa-circle text-gray-300 text-xl"></i>';
                    }

                    btn.className = btnClass;
                    btn.innerHTML = `<span>${type}</span> ${iconHTML}`;
                    btn.onclick = () => this.toggleHomeworkStatus(type);
                    grid.appendChild(btn);
                });
                
                document.getElementById('homework-modal').classList.remove('hidden');
            },

            toggleHomeworkStatus: function(type) {
                const dateKey = this.currentHomeworkDate;
                if (!this.data.homework) this.data.homework = {};
                if (!this.data.homework[dateKey]) this.data.homework[dateKey] = {};
                if (!this.data.homework[dateKey][this.currentEditingStudent]) this.data.homework[dateKey][this.currentEditingStudent] = {};
                
                const currentStatus = this.data.homework[dateKey][this.currentEditingStudent][type] || 'none';
                
                let nextStatus = 'none';
                if (currentStatus === 'none') nextStatus = 'missing';
                else if (currentStatus === 'missing') nextStatus = 'resolved';
                else if (currentStatus === 'resolved') nextStatus = 'none';

                if (nextStatus === 'none') {
                    delete this.data.homework[dateKey][this.currentEditingStudent][type];
                } else {
                    this.data.homework[dateKey][this.currentEditingStudent][type] = nextStatus;
                }
                
                this.saveToCloud();
                this.openHomeworkModal(this.currentEditingStudent);
                this.renderHomeworkGrid(); 
            },

            markAllResolved: function() {
                 const dateKey = this.currentHomeworkDate;
                 if (!this.data.homework || !this.data.homework[dateKey]) return;
                 
                 const studentData = this.data.homework[dateKey][this.currentEditingStudent];
                 if (!studentData) return;

                 Object.keys(studentData).forEach(key => {
                     if (studentData[key] === 'missing') {
                         studentData[key] = 'resolved';
                     }
                 });

                 this.saveToCloud();
                 this.openHomeworkModal(this.currentEditingStudent); 
                 this.renderHomeworkGrid();
            },

            closeHomeworkModal: function() {
                document.getElementById('homework-modal').classList.add('hidden');
                this.renderHomeworkGrid();
            },

            // ================= 自訂分頁邏輯 (保留以防未來需要) =================
            
            openAddTabModal: function() {
                this.editingTabId = null;
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus-circle mr-2 text-blue-500"></i> 新增自訂分頁';
                document.getElementById('modal-submit-btn').innerHTML = '<i class="fas fa-save mr-1"></i> 新增分頁';
                document.getElementById('new-tab-title').value = '';
                document.getElementById('new-tab-code').value = '';
                document.getElementById('add-tab-modal').classList.remove('hidden');
            },

            openEditTabModal: function(tabId) {
                this.editingTabId = tabId;
                const tabData = this.data.customTabs.find(t => t.id === tabId);
                if (!tabData) return;
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-pen mr-2 text-blue-500"></i> 修改分頁內容';
                document.getElementById('modal-submit-btn').innerHTML = '<i class="fas fa-check mr-1"></i> 儲存修改';
                document.getElementById('new-tab-title').value = tabData.title;
                document.getElementById('new-tab-code').value = tabData.content || '';
                document.getElementById('add-tab-modal').classList.remove('hidden');
            },
            
            deleteTab: function(tabId) {
                if(confirm('確定要刪除這個分頁嗎？')) {
                    this.data.customTabs = this.data.customTabs.filter(t => t.id !== tabId);
                    this.saveToCloud();
                    if(this.activeTabId === tabId) this.switchTab('home');
                    else this.renderTabs();
                }
            },

            closeAddTabModal: function() {
                document.getElementById('add-tab-modal').classList.add('hidden');
            },

            confirmAddOrEditTab: function() {
                const title = document.getElementById('new-tab-title').value.trim();
                let input = document.getElementById('new-tab-code').value.trim();
 
                if (!title || !input) {
                    alert('請輸入名稱與網址(或代碼)！'); return;
                }
 
                input = input.replace(/youtube\.com\/watch\?v=([^&"\s]+)/g, 'youtube.com/embed/$1');
                input = input.replace(/youtu\.be\/([^?"\s]+)/g, 'youtube.com/embed/$1');
 
                if (!this.data.customTabs) this.data.customTabs = [];
                
                let targetTabId;
                if (this.editingTabId) {
                    const tabIndex = this.data.customTabs.findIndex(t => t.id === this.editingTabId);
                    if (tabIndex > -1) {
                        this.data.customTabs[tabIndex].title = title;
                        this.data.customTabs[tabIndex].content = input;
                        targetTabId = this.editingTabId;
                    }
                } else {
                    const newId = 'tab-' + Date.now();
                    this.data.customTabs.push({
                        id: newId,
                        title: title,
                        content: input,
                        type: 'custom'
                    });
                    targetTabId = newId;
                }
                
                this.saveToCloud();
                this.renderTabs();
                this.closeAddTabModal();
                this.switchTab(targetTabId);
            }
        };
        
        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>
