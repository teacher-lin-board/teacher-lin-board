<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šé»‘æ¿ - å°ˆå±¬é›²ç«¯ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@600&family=Mali:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        .blackboard {
            background-color: #2b3a28;
            background-image: radial-gradient(#4a5d46 1px, transparent 1px), radial-gradient(#4a5d46 1px, transparent 1px);
            background-position: 0 0, 20px 20px; background-size: 40px 40px;
            box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.3);
            border: 12px solid #8B4513; border-radius: 8px; color: #fff; font-family: 'Noto Serif TC', serif;
        }
        .chalk-text { color: rgba(255, 255, 255, 0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .chalk-input {
            background: transparent; border: none; border-bottom: 1px dashed rgba(255,255,255,0.3);
            color: white; font-family: 'Noto Serif TC', serif; width: 100%; padding: 4px; transition: font-size 0.2s, height 0.2s;
        }
        .chalk-input:focus { outline: none; border-bottom: 1px solid white; background: rgba(255,255,255,0.1); }
        .cb-delete-btn { opacity: 0; transition: opacity 0.2s; cursor: pointer; color: #ef4444; margin-left: 8px; padding: 4px; }
        .group:hover .cb-delete-btn { opacity: 0.6; }
        .cb-delete-btn:hover { opacity: 1 !important; }
        .sticky-note { background-color: #fef08a; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 4px; border-top: 10px solid rgba(255,255,0,0.3); }
        .duty-card { background-color: #e0f2fe; border-left: 4px solid #3b82f6; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
        
        @keyframes blinker { 50% { opacity: 0.3; color: red; } }
        .blink-active { animation: blinker 1.5s linear infinite; font-weight: bold; }
        .content-area { height: calc(100vh - 60px); overflow-y: hidden; }
        .scrollable-content { height: 100%; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .tab-btn {
            white-space: nowrap; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
            border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
        }
        .tab-active { background-color: #f3f4f6; color: #1e40af; border-bottom: 3px solid #1e40af; }
        .tab-inactive { background-color: white; color: #64748b; border-bottom: 3px solid transparent; }
        .tab-inactive:hover { background-color: #f1f5f9; }
        
        /* ç·¨è¼¯æŒ‰éˆ•æ¨£å¼ */
        .tab-edit-btn { 
            width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            margin-left: 8px; color: #94a3b8; transition: all 0.2s; cursor: pointer; background: rgba(0,0,0,0.05); 
        }
        .tab-edit-btn:hover { background-color: #3b82f6; color: white; transform: scale(1.1); }
        
        .add-tab-btn { background-color: rgba(255,255,255,0.8); color: #1e40af; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; flex-shrink: 0; }
        .add-tab-btn:hover { background-color: #1e40af; color: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .workbook-bg { background-color: #ffffff; background-image: linear-gradient(rgba(200, 220, 200, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(200, 220, 200, 0.4) 1px, transparent 1px); background-size: 20px 20px; position: relative; }
        .student-grid-cell { min-height: 90px; display: flex; flex-direction: column; border-radius: 10px; transition: all 0.2s; position: relative; cursor: pointer; overflow: hidden; background-color: #22c55e; border: 2px solid #ffffff; box-shadow: 0 3px 5px rgba(0,0,0,0.12); }
        .student-grid-cell:hover { transform: translateY(-2px); background-color: #16a34a; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .cell-tape { position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 30px; height: 15px; background-color: rgba(255,255,255,0.4); z-index: 0; }
        .cute-font { font-family: 'Mali', 'Noto Sans TC', cursive; }

        @media print {
            body { overflow: auto; background: white; }
            header, .no-print { display: none !important; }
            .print-visible { display: block !important; }
            .content-area { height: auto; overflow: visible; }
            #homework-grid { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- é ‚éƒ¨å°è¦½åˆ—èˆ‡åˆ†é  -->
    <header class="h-[60px] bg-white border-b shadow-sm flex items-center px-4 justify-between shrink-0 z-10">
        <div class="flex items-center h-full pt-2 max-w-[70%]">
            <div class="flex items-center space-x-1 overflow-x-auto no-scrollbar h-full" id="tabs-container"></div>
            <!-- å‹•æ…‹æ–°å¢åˆ†é æŒ‰éˆ• -->
            <button onclick="app.openAddTabModal()" class="add-tab-btn" title="æ–°å¢åˆ†é ">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-500 flex items-center mr-2 font-bold bg-gray-100 px-2 py-1 rounded-full">
                <i class="fas fa-circle-notch fa-spin mr-1"></i> ç³»çµ±å•Ÿå‹•ä¸­...
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow relative bg-gray-100 flex flex-col overflow-hidden" id="main-content"></main>

    <!-- ============================================== -->
    <!-- éš±è—çš„æ¨¡æ¿å€åŸŸ -->
    <!-- ============================================== -->
    <div style="display:none;">
        
        <!-- é¦–é é»‘æ¿æ¨¡æ¿ -->
        <div id="template-home">
             <div class="grid grid-cols-12 gap-4 h-full p-4">
                <div class="col-span-12 md:col-span-3 flex flex-col gap-4 h-full">
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500 shrink-0">
                        <div class="flex items-end justify-between">
                            <div><div id="clock-time" class="text-4xl font-mono font-bold text-gray-800 tracking-wider">00:00:00</div><div id="clock-date" class="text-lg text-gray-500 mt-1 font-medium">Loading...</div></div>
                            <div class="text-3xl text-blue-500"><i class="far fa-clock"></i></div>
                        </div>
                    </div>
                    <div class="duty-card p-3 shrink-0">
                        <h3 class="font-bold text-blue-800 text-lg mb-2 flex items-center"><i class="fas fa-user-friends mr-2"></i>ä»Šæ—¥å€¼æ—¥ç”Ÿ</h3>
                        <div class="flex gap-2 items-center">
                            <div class="flex-1"><input type="number" id="duty-1" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                            <span class="text-blue-400 font-bold">&</span>
                            <div class="flex-1"><input type="number" id="duty-2" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                        </div>
                    </div>
                    <div class="sticky-note flex-grow flex flex-col p-4 relative min-h-0">
                        <div class="flex justify-between items-center mb-2 border-b border-yellow-400 pb-2 shrink-0">
                            <h3 class="font-bold text-gray-700 text-xl"><i class="fas fa-bullhorn mr-2"></i>è€å¸«å®åš€</h3>
                            <div class="flex gap-1 items-center bg-white/50 p-1 rounded">
                                <button onclick="app.adjustFontSize(-2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-minus"></i></button>
                                <button onclick="app.adjustFontSize(2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-plus"></i></button>
                                <div class="w-px h-4 bg-gray-400 mx-1"></div>
                                <input type="color" id="reminder-color" oninput="app.updateReminderStyle()" value="#000000" class="w-5 h-5 cursor-pointer border-0 p-0 rounded bg-transparent">
                                <button id="blink-toggle" onclick="app.toggleBlink()" class="text-gray-400 hover:text-red-500 transition px-1"><i class="fas fa-bolt"></i></button>
                            </div>
                        </div>
                        <textarea id="reminder-text" oninput="app.saveSettings()" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 text-xl leading-relaxed" placeholder="åœ¨é€™è£¡è¼¸å…¥çµ¦å…¨ç­çš„æé†’äº‹é …..." style="font-size: 24px;"></textarea>
                    </div>
                </div>
                <div class="col-span-12 md:col-span-9 h-full flex flex-col">
                    <div class="blackboard h-full p-6 flex flex-col relative">
                        <div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-600 pb-2 shrink-0">
                            <div class="flex items-center gap-4">
                                <h2 class="text-3xl font-bold text-white tracking-widest"><i class="fas fa-book-open mr-2"></i>è¯çµ¡ç°¿</h2>
                                <span id="board-date-display" class="text-2xl text-yellow-300 font-mono">2023/--/-- (ä¸€)</span>
                            </div>
                            <div class="flex gap-4 items-center">
                                <div class="flex gap-1 bg-white/10 rounded px-2 py-1 items-center">
                                    <button onclick="app.changeContactBookFontSize(-2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>-</button>
                                    <span class="text-xs text-gray-300">å­—é«”</span>
                                    <button onclick="app.changeContactBookFontSize(2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>+</button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.changeWeek(-1)" class="text-gray-300 hover:text-white px-2 py-1 border border-gray-500 rounded hover:bg-white/10 text-sm">ä¸Šé€±</button>
                                    <button onclick="app.changeWeek(1)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded shadow font-bold text-sm"><i class="fas fa-calendar-check mr-1"></i>æ–°çš„ä¸€é€±</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1 mb-2 overflow-x-auto shrink-0">
                            <button onclick="app.switchDay(0)" id="day-btn-0" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±ä¸€</button>
                            <button onclick="app.switchDay(1)" id="day-btn-1" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±äºŒ</button>
                            <button onclick="app.switchDay(2)" id="day-btn-2" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±ä¸‰</button>
                            <button onclick="app.switchDay(3)" id="day-btn-3" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±å››</button>
                            <button onclick="app.switchDay(4)" id="day-btn-4" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±äº”</button>
                        </div>
                        <div class="flex-grow flex gap-6 overflow-hidden pt-2">
                            <div class="flex-grow flex flex-col overflow-y-auto pr-2 w-7/12">
                                <div id="todo-list" class="space-y-3 mb-2"></div>
                                <div class="mb-4">
                                    <button onclick="app.addTodoItem()" class="text-yellow-400 hover:text-yellow-200 text-sm border border-dashed border-yellow-600 hover:border-yellow-400 px-3 py-1 rounded transition flex items-center"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                                </div>
                            </div>
                            <div class="w-px bg-white/10 border-l border-dashed border-gray-500/50"></div>
                            <div class="w-5/12 flex flex-col gap-2 min-w-[200px]">
                                <div class="bg-black/20 rounded p-2 text-center relative">
                                    <label class="block text-yellow-300 text-lg mb-1 font-bold">ä»Šæ—¥æˆèª</label>
                                    <div class="absolute top-2 right-2 flex gap-1 z-10">
                                        <button onclick="app.changeIdiomFontSize(-2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-minus"></i></button>
                                        <button onclick="app.changeIdiomFontSize(2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <input type="text" id="idiom-input" oninput="app.saveContactBook()" class="chalk-input text-2xl text-center font-bold text-yellow-100 w-full" placeholder="è¼¸å…¥æˆèª">
                                </div>
                                <textarea id="idiom-desc" oninput="app.saveContactBook()" class="chalk-input text-xl text-gray-200 resize-none flex-grow p-2" placeholder="åœ¨æ­¤è¼¸å…¥è§£é‡‹æˆ–ä¾‹å¥..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½œæ¥­ç®¡ç†æ¨¡æ¿ -->
        <div id="template-homework" class="w-full h-full workbook-bg">
            <div class="flex flex-col h-full ml-0">
                <div class="p-2 md:p-3 flex flex-wrap items-center justify-between gap-2 shrink-0 no-print bg-white/80 backdrop-blur border-b border-green-100 m-2 rounded-xl shadow-sm">
                    <div class="flex items-center gap-2"><div class="bg-green-500 text-white p-2 rounded-full shadow"><i class="fas fa-book text-lg"></i></div><h2 class="text-lg md:text-xl font-bold text-slate-700 cute-font">ä½œæ¥­ç¹³äº¤ç´€éŒ„ç°¿</h2></div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-3">
                        <div class="flex items-center gap-2 bg-white px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-green-200 shadow-inner">
                            <i class="fas fa-calendar-alt text-green-500"></i><input type="date" id="homework-date" onchange="app.changeHomeworkDate(this.value)" class="bg-transparent border-none outline-none font-bold text-slate-600 text-sm cursor-pointer cute-font">
                        </div>
                        <div class="flex items-center gap-1 bg-red-50 px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-red-100">
                            <span class="text-sm font-bold text-red-400">å¾…è£œ:</span><span id="pending-count-badge" class="text-base font-black text-red-500 cute-font">0</span>
                        </div>
                        <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 text-sm font-bold shadow"><i class="fas fa-print"></i></button>
                    </div>
                </div>
                <div class="flex-grow p-2 md:p-4 overflow-y-auto scrollable-content" id="homework-scroll-area">
                    <div class="mb-3 flex flex-wrap gap-2 items-center bg-white/80 p-2 rounded-xl border border-green-100 no-print shadow-sm">
                        <span class="text-sm font-bold text-slate-500 cute-font">å¿«é€Ÿæ–°å¢ï¼š</span>
                        <input type="text" id="new-hw-type" placeholder="é …ç›®åç¨±" class="border border-green-200 rounded-full px-3 py-1 text-sm focus:outline-none focus:border-green-400 w-28 md:w-32 bg-white">
                        <button onclick="app.addHomeworkType()" class="bg-green-500 text-white hover:bg-green-600 px-3 py-1 rounded-full text-sm font-bold transition shadow-sm"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="homework-grid" class="grid grid-cols-7 gap-2 md:gap-3 pb-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ä¿®æ”¹æ»¿ç‰ˆåˆ†é  Modal -->
    <div id="add-tab-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 flex flex-col max-h-[90vh]">
            <h3 id="modal-title" class="text-2xl font-bold text-blue-900 mb-2 border-b-2 border-blue-100 pb-2 flex items-center">
                <i class="fas fa-code mr-2 text-blue-500"></i> æ–°å¢è‡ªè¨‚åˆ†é 
            </h3>
            <p class="text-sm text-blue-700 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <i class="fas fa-shield-alt text-green-600 mr-1"></i> <strong>å·²å•Ÿç”¨æ²™ç›’éš”é›¢æŠ€è¡“</strong><br>
                æ‚¨å¯ä»¥è²¼ä¸Š AI ç”Ÿæˆçš„å®Œæ•´ HTML ä»£ç¢¼ã€ä»»ä½•ç¶²å€ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹ç¨ç«‹ç’°å¢ƒé‹è¡Œï¼Œç¢ºä¿æ’ç‰ˆèˆ‡ç¨‹å¼ç¢¼ 100% å®Œæ•´å‘ˆç¾ã€‚
            </p>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">1. åˆ†é åç¨±</label>
                <input type="text" id="new-tab-title" class="w-full border-2 border-gray-200 focus:border-blue-400 p-2 rounded outline-none transition" placeholder="ä¾‹å¦‚ï¼šè¨‚æ­£å°å·¥å…·">
            </div>
            <div class="mb-6 flex-grow flex flex-col">
                <label class="block text-gray-700 font-bold mb-2">2. è²¼ä¸Š HTML åŸå§‹ç¢¼ æˆ– ç›´æ¥è²¼ç¶²å€</label>
                <textarea id="new-tab-code" class="w-full border-2 border-gray-200 focus:border-blue-400 p-2 rounded outline-none transition flex-grow resize-none font-mono text-sm" placeholder='è«‹è²¼ä¸Šå®Œæ•´ HTML åŸå§‹ç¢¼ã€ç¶²å€æˆ– <iframe ...> èªæ³•'></textarea>
            </div>
            <div class="flex justify-end gap-3 mt-auto pt-4 border-t border-gray-100">
                <button onclick="app.closeAddTabModal()" class="px-5 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">å–æ¶ˆ</button>
                <button id="modal-submit-btn" onclick="app.confirmAddOrEditTab()" class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition"><i class="fas fa-save mr-1"></i> å„²å­˜åˆ†é </button>
            </div>
        </div>
    </div>

    <!-- ä½œæ¥­å‹¾é¸ Modal -->
    <div id="homework-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-green-500 text-white p-6 flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10"><span class="text-green-100 text-sm font-medium uppercase tracking-wider">å­¸ç”Ÿåº§è™Ÿ</span><div class="text-5xl font-black leading-none cute-font" id="modal-student-id">--</div></div>
                <button onclick="app.closeHomeworkModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors relative z-10"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-green-50">
                <div id="homework-types-grid" class="grid grid-cols-2 gap-3"></div>
            </div>
            <div class="p-4 bg-white border-t border-green-100 flex justify-between items-center">
                <button onclick="app.markAllResolved()" class="flex items-center gap-2 text-green-600 font-bold hover:bg-green-50 px-4 py-2 rounded-lg transition-colors"><i class="fas fa-check-circle"></i> å…¨éƒ¨è£œäº¤</button>
                <button onclick="app.closeHomeworkModal()" class="bg-slate-700 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-800 transition-colors shadow-lg">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================================
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹å°‡æ‚¨åœ¨ Firebase ç”³è«‹çš„è¨­å®šã€Œæ›¿æ›ã€æ‰ä¸‹é¢é€™å€å¡Š ğŸ‘‡ğŸ‘‡ğŸ‘‡
        // =======================================================================
        const firebaseConfig = {
           apiKey: "AIzaSyAT9VXm8gf5Pn4A1iu3xXF6X8Ve9NYlUAk",
  authDomain: "teacherboard-9224d.firebaseapp.com",
  projectId: "teacherboard-9224d",
  storageBucket: "teacherboard-9224d.firebasestorage.app",
  messagingSenderId: "801036213120",
  appId: "1:801036213120:web:2077de68b0a74395023f65"
        };
        // =======================================================================

        let db, docRef;

        const app = {
            tabs: [ { id: 'home', title: 'è¯çµ¡ç°¿', type: 'system', icon: 'fa-home' }, { id: 'homework', title: 'ä½œæ¥­ç®¡ç†', type: 'system', icon: 'fa-book' } ],
            settings: { reminderText: '', reminderColor: '#000000', reminderFontSize: 24, reminderBlink: false, duty1: '', duty2: '', contactBookFontSize: 24, idiomFontSize: 24, homeworkTypes: ["ç”Ÿå­—", "åœˆçŸ­", "çŸ­é€ ", "åœ‹ç¿’", "è½è€ƒ", "åœ‹å·", "æ•¸ç¿’", "æ•¸ä½œ", "æ•¸å·", "æ•¸å…«", "ä½œæ–‡", "è¯çµ¡ç°¿", "å›æ¢", "é€±è¨˜"] },
            data: { contactBook: {}, homework: {}, memos: {}, customTabs: [] },
            
            saveTimeout: null, activeTabId: 'home', currentWeekBase: null, currentDayIndex: 0, currentHomeworkDate: new Date().toISOString().split('T')[0], currentEditingStudent: null,
            editingTabId: null, 
            
            init: function() {
                this.currentWeekBase = this.getMonday(new Date());
                const day = new Date().getDay();
                this.currentDayIndex = (day === 0 || day === 6) ? 0 : day - 1; 
                this.renderTabs();
                this.switchTab('home');
                this.startClock();
                document.getElementById('homework-date').value = this.currentHomeworkDate;

                const statusEl = document.getElementById('sync-status');
                if (firebaseConfig.apiKey.includes("è«‹åœ¨é€™è£¡è²¼ä¸Š") || !firebaseConfig.apiKey) {
                    if(statusEl) statusEl.innerHTML = '<span class="text-red-500 bg-red-100 px-3 py-1 rounded-full"><i class="fas fa-exclamation-triangle"></i> è«‹ä¿®æ”¹ç¨‹å¼ç¢¼å¡«å¯«é›²ç«¯é‡‘é‘°</span>';
                    return; 
                }

                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    docRef = doc(db, "Classrooms", "TeacherBoard_Data"); 
                    this.setupRealtimeListener();
                } catch (e) {
                    console.error("Firebase é€£ç·šå¤±æ•—:", e);
                }
            },

            setupRealtimeListener: function() {
                const statusEl = document.getElementById('sync-status');
                if(statusEl) statusEl.innerHTML = '<i class="fas fa-cloud-download-alt animate-bounce mr-1"></i> é€£ç·šä¸­...';

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const parsed = docSnap.data();
                        if (parsed.settings) this.settings = { ...this.settings, ...parsed.settings };
                        if (parsed.data) {
                            this.data = { ...this.data, ...parsed.data };
                            if (!this.data.customTabs) this.data.customTabs = [];
                        }
                        
                        this.renderTabs();
                        if (this.activeTabId === 'home') this.initHomeView();
                        else if (this.activeTabId === 'homework') this.renderHomeworkGrid();
                        else this.renderCustomTabView(this.activeTabId);
                        
                        if(statusEl) {
                             statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                             statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> é›²ç«¯åŒæ­¥å®Œæˆ';
                        }
                    } else {
                        this.saveToCloud();
                    }
                });
            },

            saveToCloud: function() {
                if (!docRef) return;
                const statusEl = document.getElementById('sync-status');
                if (statusEl) { statusEl.className = "text-xs text-blue-600 flex items-center mr-2 font-bold bg-blue-50 px-2 py-1 rounded-full"; statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> ä¸Šå‚³ä¸­...'; }

                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(async () => {
                    try {
                        await setDoc(docRef, { settings: this.settings, data: this.data }, { merge: true });
                        if (statusEl) { statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200"; statusEl.innerHTML = '<i class="fas fa-cloud-upload-alt mr-1"></i> å·²å„²å­˜è‡³é›²ç«¯'; }
                    } catch (e) { console.error("å„²å­˜å¤±æ•—:", e); }
                }, 800);
            },

            renderTabs: function() {
                const container = document.getElementById('tabs-container'); 
                container.innerHTML = '';
                
                this.tabs.forEach(tab => this.createTabElement(container, tab, false));
                if (this.data.customTabs) {
                    this.data.customTabs.forEach(tab => this.createTabElement(container, tab, true));
                }
            },
            
            createTabElement: function(container, tab, isCustom) {
                const el = document.createElement('div'); 
                el.className = `tab-btn ${tab.id === this.activeTabId ? 'tab-active' : 'tab-inactive'}`;
                el.onclick = () => this.switchTab(tab.id);
                
                const iconClass = isCustom ? 'fa-globe' : (tab.icon || 'fa-folder-open');
                el.innerHTML = `<i class="fas ${iconClass} mr-2"></i><span>${tab.title}</span>`;
                
                if (isCustom) {
                    const editBtn = document.createElement('div');
                    editBtn.className = 'tab-edit-btn';
                    editBtn.title = "ä¿®æ”¹æˆ–æ›¿æ›æ­¤åˆ†é ";
                    editBtn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                    editBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); app.openEditTabModal(tab.id); });
                    el.appendChild(editBtn);
                }
                
                container.appendChild(el);
            },

            switchTab: function(tabId) {
                this.activeTabId = tabId; 
                this.renderTabs(); 
                const main = document.getElementById('main-content'); 
                main.innerHTML = '';
                
                if (tabId === 'home') { 
                    main.appendChild(document.getElementById('template-home').firstElementChild.cloneNode(true)); 
                    this.initHomeView(); 
                } 
                else if (tabId === 'homework') { 
                    main.appendChild(document.getElementById('template-homework').firstElementChild.cloneNode(true)); 
                    this.renderHomeworkGrid(); 
                }
                else { this.renderCustomTabView(tabId); }
            },

            openAddTabModal: function() {
                this.editingTabId = null;
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-plus-circle mr-2 text-blue-500"></i> æ–°å¢è‡ªè¨‚åˆ†é ';
                document.getElementById('modal-submit-btn').innerHTML = '<i class="fas fa-save mr-1"></i> æ–°å¢åˆ†é ';
                document.getElementById('new-tab-title').value = '';
                document.getElementById('new-tab-code').value = '';
                document.getElementById('add-tab-modal').classList.remove('hidden');
            },

            openEditTabModal: function(tabId) {
                this.editingTabId = tabId;
                const tabData = this.data.customTabs.find(t => t.id === tabId);
                if (!tabData) return;
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-pen mr-2 text-blue-500"></i> ä¿®æ”¹åˆ†é å…§å®¹';
                document.getElementById('modal-submit-btn').innerHTML = '<i class="fas fa-check mr-1"></i> å„²å­˜ä¿®æ”¹';
                document.getElementById('new-tab-title').value = tabData.title;
                document.getElementById('new-tab-code').value = tabData.content || ''; 
                document.getElementById('add-tab-modal').classList.remove('hidden');
            },

            closeAddTabModal: function() { document.getElementById('add-tab-modal').classList.add('hidden'); },

            confirmAddOrEditTab: async function() {
                const title = document.getElementById('new-tab-title').value.trim();
                let input = document.getElementById('new-tab-code').value.trim();

                if (!title || !input) { alert('è«‹è¼¸å…¥åç¨±èˆ‡ç¶²å€(æˆ–ä»£ç¢¼)ï¼'); return; }

                // YouTube èˆ‡ Wordwall ç¶²å€è‡ªå‹•è½‰æ›
                input = input.replace(/youtube\.com\/watch\?v=([^&"\s]+)/g, 'youtube.com/embed/$1');
                input = input.replace(/youtu\.be\/([^?"\s]+)/g, 'youtube.com/embed/$1');
                input = input.replace(/\/(?:tc\/)?(?:resource|play)\/([^/"\s]+)(?:\/([^"\s]*))?/g, '/embed/$1');

                if (!this.data.customTabs) this.data.customTabs = [];
                
                let targetTabId;
                if (this.editingTabId) {
                    const tabIndex = this.data.customTabs.findIndex(t => t.id === this.editingTabId);
                    if (tabIndex > -1) {
                        this.data.customTabs[tabIndex].title = title;
                        this.data.customTabs[tabIndex].content = input;
                    }
                    targetTabId = this.editingTabId;
                } else {
                    const newId = 'embed_' + Date.now();
                    this.data.customTabs.push({ id: newId, title: title, content: input });
                    targetTabId = newId;
                }
                
                this.closeAddTabModal();
                this.activeTabId = targetTabId;
                this.renderTabs();
                this.switchTab(targetTabId);
                this.saveToCloud();
            },

            // ==========================================
            // ğŸ”¥ çµ‚æ¥µæ²™ç›’éš”é›¢æ¸²æŸ“å¼•æ“ (è§£æ±º AI ä»£ç¢¼å¤±æ•ˆèˆ‡æ’ç‰ˆè·‘æ‰) ğŸ”¥
            // ==========================================
            renderCustomTabView: function(tabId) {
                const main = document.getElementById('main-content');
                const tabData = this.data.customTabs.find(t => t.id === tabId);
                if (!tabData) return;
                
                main.innerHTML = `
                    <div class="w-full h-full relative group bg-white">
                        <div class="absolute top-2 right-4 bg-black/60 text-white px-3 py-1.5 rounded-lg text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg backdrop-blur-sm">
                            <i class="fas fa-info-circle mr-1"></i> ${tabData.title}
                        </div>
                        <!-- ä½¿ç”¨çµ•å°å®šä½ç¢ºä¿å®¹å™¨100%å¡«æ»¿ï¼Œä¸æœƒè¢«å…¶ä»–å…ƒç´ æ“ å£“ -->
                        <div id="embed-wrapper-${tabId}" class="absolute inset-0 w-full h-full overflow-hidden">
                        </div>
                    </div>
                `;

                const wrapper = document.getElementById(`embed-wrapper-${tabId}`);
                const content = tabData.content.trim();

                const isIframe = content.toLowerCase().startsWith('<iframe') || content.toLowerCase().includes('<iframe');
                const isURL = (content.startsWith('http://') || content.startsWith('https://')) && !content.includes('<');

                if (isURL) {
                    // æƒ…å¢ƒä¸€ï¼šç´”ç¶²å€ -> ç›´æ¥åŒ…è£ iframe
                    const iframe = document.createElement('iframe');
                    iframe.src = content;
                    iframe.style.position = 'absolute'; iframe.style.top = '0'; iframe.style.left = '0';
                    iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = 'none';
                    iframe.setAttribute('allow', 'autoplay; fullscreen; microphone; camera; display-capture');
                    wrapper.appendChild(iframe);
                } else if (isIframe && !content.toLowerCase().includes('<!doctype html>')) {
                    // æƒ…å¢ƒäºŒï¼šå–®ç´”çš„ Iframe åµŒå…¥ç¢¼ -> ç§»é™¤æ²å‹•é™åˆ¶ä¸¦å¼·åˆ¶æ»¿ç‰ˆ
                    wrapper.innerHTML = content;
                    const iframes = wrapper.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        iframe.style.position = 'absolute'; iframe.style.top = '0'; iframe.style.left = '0';
                        iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = 'none';
                        iframe.removeAttribute('scrolling');
                        if (!iframe.hasAttribute('allow')) iframe.setAttribute('allow', 'autoplay; fullscreen; microphone; camera; display-capture');
                    });
                } else {
                    // ğŸ”¥ æƒ…å¢ƒä¸‰ (æœ€é‡è¦)ï¼šå®Œæ•´ HTML åŸå§‹ç¢¼ (å¦‚ Canva AI) -> å•Ÿç”¨ srcdoc æ²™ç›’æ©Ÿåˆ¶
                    // åˆ©ç”¨ iframe çš„ srcdoc å±¬æ€§ï¼Œå‰µé€ ä¸€å€‹ç¨ç«‹çš„å¾®å‹ç€è¦½å™¨ç’°å¢ƒï¼Œ
                    // é€™æ¨£å®ƒå…§éƒ¨çš„ window.onload ç­‰è¼‰å…¥äº‹ä»¶å°±æœƒæ­£å¸¸è§¸ç™¼ï¼Œä¸” CSS å®Œå…¨ä¸æœƒè·Ÿé»‘æ¿æ‰“æ¶ï¼
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'absolute'; iframe.style.top = '0'; iframe.style.left = '0';
                    iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = 'none';
                    iframe.setAttribute('allow', 'autoplay; fullscreen; microphone; camera; display-capture');
                    iframe.srcdoc = content; // å°‡ HTML åŸå§‹ç¢¼çŒå…¥æ²™ç›’
                    wrapper.appendChild(iframe);
                }
            },

            // --- å…¶ä»–åŸç”ŸåŠŸèƒ½ ---
            saveSettings: function() {
                this.settings.duty1 = document.getElementById('duty-1').value; this.settings.duty2 = document.getElementById('duty-2').value;
                this.settings.reminderText = document.getElementById('reminder-text').value; this.saveToCloud();
            },
            getMonday: function(d) { d = new Date(d); const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); },
            formatDate: function(date) { return date.toISOString().split('T')[0]; },
            initHomeView: function() {
                document.getElementById('duty-1').value = this.settings.duty1 || ''; document.getElementById('duty-2').value = this.settings.duty2 || '';
                const reminder = document.getElementById('reminder-text');
                reminder.value = this.settings.reminderText || ''; reminder.style.fontSize = this.settings.reminderFontSize + 'px'; reminder.style.color = this.settings.reminderColor;
                document.getElementById('reminder-color').value = this.settings.reminderColor;
                if(this.settings.reminderBlink) reminder.classList.add('blink-active');
                if(!this.settings.idiomFontSize) this.settings.idiomFontSize = 24; this.applyIdiomFontSize(); this.renderContactBook();
            },
            startClock: function() {
                const update = () => {
                    const now = new Date(); const timeEl = document.getElementById('clock-time'); const dateEl = document.getElementById('clock-date');
                    if (timeEl) timeEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
                    if (dateEl) dateEl.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                }; setInterval(update, 1000); update();
            },
            adjustFontSize: function(delta) { this.settings.reminderFontSize += delta; document.getElementById('reminder-text').style.fontSize = this.settings.reminderFontSize + 'px'; this.saveToCloud(); },
            updateReminderStyle: function() { this.settings.reminderColor = document.getElementById('reminder-color').value; document.getElementById('reminder-text').style.color = this.settings.reminderColor; this.saveToCloud(); },
            toggleBlink: function() { this.settings.reminderBlink = !this.settings.reminderBlink; const el = document.getElementById('reminder-text'); if (this.settings.reminderBlink) el.classList.add('blink-active'); else el.classList.remove('blink-active'); this.saveToCloud(); },
            changeWeek: function(delta) { this.currentWeekBase.setDate(this.currentWeekBase.getDate() + (delta * 7)); this.renderContactBook(); },
            switchDay: function(index) { this.currentDayIndex = index; this.renderContactBook(); },
            getCurrentBoardDateKey: function() { const d = new Date(this.currentWeekBase); d.setDate(d.getDate() + this.currentDayIndex); return this.formatDate(d); },
            renderContactBook: function() {
                for(let i=0; i<5; i++) {
                    const btn = document.getElementById(`day-btn-${i}`);
                    if (i === this.currentDayIndex) { btn.classList.remove('bg-white/10', 'text-gray-300'); btn.classList.add('bg-blue-600', 'text-white', 'scale-110'); } 
                    else { btn.classList.add('bg-white/10', 'text-gray-300'); btn.classList.remove('bg-blue-600', 'text-white', 'scale-110'); }
                }
                const dateKey = this.getCurrentBoardDateKey(); const d = new Date(dateKey);
                document.getElementById('board-date-display').textContent = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`;
                const dayData = this.data.contactBook[dateKey] || { todos: [], idiom: '', idiomDesc: '' };
                document.getElementById('idiom-input').value = dayData.idiom || ''; document.getElementById('idiom-desc').value = dayData.idiomDesc || '';
                const list = document.getElementById('todo-list'); list.innerHTML = '';
                (dayData.todos || []).forEach((todo, idx) => {
                    const row = document.createElement('div'); row.className = 'group flex items-center mb-1';
                    row.innerHTML = `<span class="text-yellow-400 mr-2 text-xl">â€¢</span><input type="text" class="chalk-input text-xl flex-grow" value="${todo}" oninput="app.updateTodo(${idx}, this.value)" style="font-size: ${this.settings.contactBookFontSize}px"><i class="fas fa-trash cb-delete-btn" onclick="app.deleteTodo(${idx})"></i>`;
                    list.appendChild(row);
                });
            },
            changeContactBookFontSize: function(delta) { this.settings.contactBookFontSize += delta; document.querySelectorAll('#todo-list input').forEach(input => input.style.fontSize = this.settings.contactBookFontSize + 'px'); this.saveToCloud(); },
            changeIdiomFontSize: function(delta) { this.settings.idiomFontSize += delta; this.applyIdiomFontSize(); this.saveToCloud(); },
            applyIdiomFontSize: function() {
                const idiomInput = document.querySelector('#main-content #idiom-input'); const idiomDesc = document.querySelector('#main-content #idiom-desc');
                if (idiomInput) idiomInput.style.fontSize = this.settings.idiomFontSize + 'px'; if (idiomDesc) idiomDesc.style.fontSize = (this.settings.idiomFontSize * 0.9) + 'px';
            },
            saveContactBook: function() {
                const dateKey = this.getCurrentBoardDateKey(); if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { todos: [] };
                this.data.contactBook[dateKey].idiom = document.getElementById('idiom-input').value; this.data.contactBook[dateKey].idiomDesc = document.getElementById('idiom-desc').value; this.saveToCloud();
            },
            addTodoItem: function() { const dateKey = this.getCurrentBoardDateKey(); if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { todos: [] }; this.data.contactBook[dateKey].todos.push(''); this.saveToCloud(); this.renderContactBook(); },
            updateTodo: function(idx, val) { const dateKey = this.getCurrentBoardDateKey(); this.data.contactBook[dateKey].todos[idx] = val; this.saveToCloud(); },
            deleteTodo: function(idx) { const dateKey = this.getCurrentBoardDateKey(); this.data.contactBook[dateKey].todos.splice(idx, 1); this.saveToCloud(); this.renderContactBook(); },
            changeHomeworkDate: function(date) { this.currentHomeworkDate = date; this.renderHomeworkGrid(); },
            renderHomeworkGrid: function() {
                const container = document.getElementById('homework-grid'); if (!container) return; container.innerHTML = '';
                const dateKey = this.currentHomeworkDate; const dayRecord = this.data.homework[dateKey] || {}; let pendingCount = 0;
                for(let i=1; i<=29; i++) { 
                    const studentData = dayRecord[i] || {};
                    const missingItems = Object.entries(studentData).filter(([k, v]) => v === 'missing').map(([k, v]) => k);
                    const resolvedItems = Object.entries(studentData).filter(([k, v]) => v === 'resolved').map(([k, v]) => k);
                    const isMissing = missingItems.length > 0; if (isMissing) pendingCount++;
                    const cell = document.createElement('div'); cell.className = `student-grid-cell relative`; cell.onclick = () => this.openHomeworkModal(i);
                    let contentHtml = `<div class="cell-tape"></div><div class="flex-grow flex items-center justify-center pt-1 pb-4"><span class="text-3xl md:text-4xl font-bold text-white cute-font drop-shadow-md">${i}</span></div>`;
                    if (isMissing || resolvedItems.length > 0) {
                        contentHtml += `<div class="absolute bottom-1 left-0 w-full px-1 flex flex-wrap gap-1 justify-center z-10">${missingItems.map(item => `<span class="bg-red-500 text-white text-sm md:text-base px-1.5 py-0 rounded shadow font-bold leading-tight">${item}</span>`).join('')}${resolvedItems.map(item => `<span class="bg-white text-green-700 text-sm md:text-base px-1.5 py-0 rounded shadow border border-green-300 font-bold leading-tight">${item}</span>`).join('')}</div>`;
                    }
                    cell.innerHTML = contentHtml; container.appendChild(cell);
                }
                document.getElementById('pending-count-badge').textContent = pendingCount;
            },
            openHomeworkModal: function(studentId) {
                this.currentEditingStudent = studentId; document.getElementById('modal-student-id').textContent = studentId;
                const grid = document.getElementById('homework-types-grid'); grid.innerHTML = '';
                const dateKey = this.currentHomeworkDate; const studentData = (this.data.homework[dateKey] && this.data.homework[dateKey][studentId]) || {};
                this.settings.homeworkTypes.forEach(type => {
                    const status = studentData[type] || 'none'; const btn = document.createElement('button');
                    let btnClass = "border rounded-lg p-3 font-bold text-lg transition flex justify-between items-center "; let iconHtml = "";
                    if (status === 'missing') { btnClass += "bg-red-100 border-red-500 text-red-600"; iconHtml = '<i class="fas fa-times-circle"></i>'; } 
                    else if (status === 'resolved') { btnClass += "bg-green-100 border-green-500 text-green-600"; iconHtml = '<i class="fas fa-check-circle"></i>'; } 
                    else { btnClass += "bg-white border-gray-200 text-gray-400 hover:border-gray-400"; }
                    btn.className = btnClass; btn.innerHTML = `<span>${type}</span>${iconHtml}`; btn.onclick = () => this.toggleHomeworkStatus(type);
                    grid.appendChild(btn);
                });
                document.getElementById('homework-modal').classList.remove('hidden');
            },
            toggleHomeworkStatus: function(type) {
                const dateKey = this.currentHomeworkDate;
                if (!this.data.homework[dateKey]) this.data.homework[dateKey] = {};
                if (!this.data.homework[dateKey][this.currentEditingStudent]) this.data.homework[dateKey][this.currentEditingStudent] = {};
                const currentStatus = this.data.homework[dateKey][this.currentEditingStudent][type] || 'none';
                let nextStatus = currentStatus === 'none' ? 'missing' : (currentStatus === 'missing' ? 'resolved' : 'none');
                if (nextStatus === 'none') delete this.data.homework[dateKey][this.currentEditingStudent][type];
                else this.data.homework[dateKey][this.currentEditingStudent][type] = nextStatus;
                this.saveToCloud(); this.openHomeworkModal(this.currentEditingStudent); this.renderHomeworkGrid();
            },
            markAllResolved: function() {
                 const dateKey = this.currentHomeworkDate; if (!this.data.homework[dateKey]) return;
                 const studentData = this.data.homework[dateKey][this.currentEditingStudent]; if (!studentData) return;
                 Object.keys(studentData).forEach(key => { if (studentData[key] === 'missing') studentData[key] = 'resolved'; });
                 this.saveToCloud(); this.openHomeworkModal(this.currentEditingStudent); this.renderHomeworkGrid();
            },
            closeHomeworkModal: function() { document.getElementById('homework-modal').classList.add('hidden'); },
            addHomeworkType: function() {
                const input = document.getElementById('new-hw-type'); const val = input.value.trim();
                if (val && !this.settings.homeworkTypes.includes(val)) { this.settings.homeworkTypes.push(val); input.value = ''; this.saveToCloud(); this.renderHomeworkGrid(); alert('å·²æ–°å¢ä½œæ¥­é …ç›®ï¼š' + val); }
            }
        };

        window.app = app;
        window.addEventListener('DOMContentLoaded', () => { app.init(); });
        
    </script>
</body>
</html>
