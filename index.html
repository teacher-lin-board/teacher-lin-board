<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šé»‘æ¿ - å°ˆå±¬é›²ç«¯ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@600&family=Mali:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        /* === é»‘æ¿èˆ‡è¯çµ¡ç°¿æ¨£å¼ === */
        .blackboard {
            background-color: #2b3a28;
            background-image: radial-gradient(#4a5d46 1px, transparent 1px), radial-gradient(#4a5d46 1px, transparent 1px);
            background-position: 0 0, 20px 20px; background-size: 40px 40px;
            box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.3);
            border: 12px solid #8B4513; border-radius: 8px; color: #fff;
            font-family: 'Noto Serif TC', serif;
        }
        .chalk-text { color: rgba(255, 255, 255, 0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .chalk-input {
            background: transparent; border: none; border-bottom: 1px dashed rgba(255,255,255,0.3);
            color: white; font-family: 'Noto Serif TC', serif; width: 100%; padding: 4px; transition: font-size 0.2s, height 0.2s;
        }
        .chalk-input:focus { outline: none; border-bottom: 1px solid white; background: rgba(255,255,255,0.1); }
        .sticky-note { background-color: #fef08a; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); border-radius: 4px; border-top: 10px solid rgba(255,255,0,0.3); }
        .duty-card { background-color: #e0f2fe; border-left: 4px solid #3b82f6; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border-radius: 4px; }
        @keyframes blinker { 50% { opacity: 0.3; color: red; } }
        .blink-active { animation: blinker 1.5s linear infinite; font-weight: bold; }
        
        /* === é€šç”¨ä»‹é¢æ¨£å¼ === */
        .content-area { height: calc(100vh - 60px); overflow-y: hidden; }
        .scrollable-content { height: 100%; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .tab-btn {
            white-space: nowrap; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500;
            border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
        }
        .tab-active { background-color: #f3f4f6; color: #1e40af; border-bottom: 3px solid #1e40af; }
        .tab-inactive { background-color: white; color: #64748b; border-bottom: 3px solid transparent; }
        .tab-inactive:hover { background-color: #f1f5f9; }

        /* === ä½œæ¥­ç®¡ç†æ¨£å¼ === */
        .workbook-bg { background-color: #ffffff; background-image: linear-gradient(rgba(200, 220, 200, 0.4) 1px, transparent 1px), linear-gradient(90deg, rgba(200, 220, 200, 0.4) 1px, transparent 1px); background-size: 20px 20px; position: relative; }
        .student-grid-cell { min-height: 90px; display: flex; flex-direction: column; border-radius: 10px; transition: all 0.2s; position: relative; cursor: pointer; overflow: hidden; background-color: #22c55e; border: 2px solid #ffffff; box-shadow: 0 3px 5px rgba(0,0,0,0.12); }
        .student-grid-cell:hover { transform: translateY(-2px); background-color: #16a34a; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .student-grid-cell.incomplete { background-color: #fff1f2; border-color: #fecdd3; }
        .student-grid-cell.incomplete:hover { background-color: #ffe4e6; }
        .cell-tape { position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(-2deg); width: 30px; height: 15px; background-color: rgba(255,255,255,0.4); z-index: 0; }
        .cute-font { font-family: 'Mali', 'Noto Sans TC', cursive; }

        /* === è¨‚æ­£ç³»çµ±æ¨£å¼ === */
        .corr-number-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .corr-number-item { display: flex; align-items: center; justify-content: center; height: 40px; background-color: #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none; font-weight: bold; color: #64748b; }
        .corr-number-item:hover { background-color: #cbd5e1; }
        .corr-number-item.selected { background-color: #3b82f6; color: white; }
        
        .corr-frame { border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 16px; margin-bottom: 20px; }
        .frame-bg-0 { background-color: #ffedd5; }
        .frame-bg-1 { background-color: #dcfce7; }
        .frame-bg-2 { background-color: #dbeafe; }
        .frame-bg-3 { background-color: #fae8ff; }
        .frame-bg-4 { background-color: #fee2e2; }
        .frame-bg-5 { background-color: #e0f2fe; }

        .time-display { background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 12px; font-weight: bold; font-size: 24px; white-space: nowrap; text-align: center; }
        .title-selector { background-color: #f1f5f9; border-radius: 10px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
        .title-chips-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; flex: 1; }
        .title-chip { background-color: #3b82f6; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; user-select: none; transition: all 0.2s; font-weight: 500; font-size: 16px; white-space: nowap; }
        .title-chip:hover { background-color: #2563eb; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .frame-header { display: flex; align-items: center; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .frame-title-input { width: 160px; font-size: 24px; font-weight: bold; padding: 4px 8px; border: 2px solid rgba(0,0,0,0.1); border-radius: 6px; background-color: rgba(255,255,255,0.9); }
        .frame-button { padding: 6px 10px; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .frame-button-select { background-color: #3b82f6; color: white; }
        .frame-button-select:hover { background-color: #2563eb; }
        .frame-button-deselect { background-color: #6b7280; color: white; }
        .frame-button-deselect:hover { background-color: #4b5563; }
        
        .add-title-inline { display: flex; align-items: center; gap: 8px; }
        .add-title-input { font-size: 16px; padding: 6px 12px; border: 2px solid #fbbf24; border-radius: 6px; width: 140px; }
        .add-title-btn { font-size: 14px; padding: 6px 12px; background-color: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .frames-container { position: relative; }
        .center-time-wrapper { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; pointer-events: none; }
        @media (min-width: 768px) { .center-time-wrapper { display: block; } }

        /* === åˆä¼‘ç™»è¨˜æ¨£å¼ === */
        .nap-bg { background: linear-gradient(to bottom right, #f0f9ff, #eff6ff, #ecfdf5); }
        .student-ball {
            width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 16px; cursor: grab; transition: transform .2s, box-shadow .2s; user-select: none;
            background-color: #3b5998 !important; color: #fff; box-shadow: 0 3px 8px rgba(0,0,0,.1), inset 0 -3px 6px rgba(0,0,0,.05), inset 0 3px 6px rgba(255,255,255,.6);
        }
        .student-ball.exempt-style { background-color: #d97706 !important; }
        .student-ball:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,.15); }
        .student-ball.dragging { opacity: .5; transform: scale(1.15); }
        .zone { border-radius: 16px; padding: 16px; transition: all .3s; display: flex; flex-direction: column; }
        .zone.drag-over { transform: scale(1.02); box-shadow: 0 0 20px rgba(255,255,255,.5); }
        .green-zone { background: linear-gradient(135deg,#d1fae5 0%,#a7f3d0 50%,#6ee7b7 100%); border: 3px solid #6ee7b7; flex: 1; }
        .yellow-zone { background: linear-gradient(135deg,#fef3c7 0%,#fde68a 50%,#fcd34d 100%); border: 3px solid #fcd34d; flex: 1; }
        .yellow-sub { background: rgba(255,255,255,.5); border-radius: 12px; padding: 8px; flex: 1; min-height: 0; }
        .red-zone { background: linear-gradient(135deg,#fed7d7 0%,#fecaca 50%,#fca5a5 100%); border: 3px solid #fca5a5; flex: 1; }
        .exempt-zone { background: linear-gradient(135deg,#fed7aa 0%,#fdba74 100%); border: 3px dashed #f59e0b; }
        .next-zone { background: linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%); border: 3px dashed #93c5fd; }
        .traffic-light { width: 20px; height: 20px; border-radius: 50%; display: inline-block; box-shadow: inset 0 -2px 4px rgba(0,0,0,.2); }
        .clock-display { font-family: 'Nunito', monospace; font-weight: 800; font-size: 1.5rem; background: linear-gradient(135deg,#1e293b 0%,#334155 100%); color: #4ade80; padding: 8px 16px; border-radius: 12px; }
        .message-input { border: 2px solid #e5e7eb; border-radius: 12px; padding: 8px 12px; font-size: .95rem; }
        .zone-title { font-weight: 700; font-size: .95rem; padding: 6px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 10px; background: rgba(255,255,255,.7); width: fit-content; }
        .balls-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-content: flex-start; flex: 1; overflow-y: auto; }

        /* === æƒåœ°æª¢æŸ¥æ¨£å¼ (å®Œå…¨é‚„åŸ) === */
        .cleaning-check-bg { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.95); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .status-box { cursor: pointer; width: 45px; height: 45px; border-radius: 6px; border: 2px solid #ccc; background: white; transition: all 0.3s ease; font-weight: 700; font-size: 10px; display: flex; align-items: center; justify-content: center; user-select: none; flex-shrink: 0; }
        .status-box:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .status-box.completed { background: #3b82f6; color: white; border-color: #3b82f6; }
        .status-box.passed { background: #10b981; color: white; border-color: #10b981; }
        .status-box.failed { background: #ef4444; color: white; border-color: #ef4444; }
        .status-box.recleaned { background: #f97316; color: white; border-color: #f97316; }
        .status-box.recleaned-passed { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        .section-divider { width: 2px; background: linear-gradient(to bottom, transparent, #e5e7eb, transparent); }

        @media print {
            body { overflow: auto; background: white; }
            header, .no-print { display: none !important; }
            .print-visible { display: block !important; }
            .content-area { height: auto; overflow: visible; }
            #homework-grid { display: grid; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
 
    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <header class="h-[60px] bg-white border-b shadow-sm flex items-center px-4 justify-between shrink-0 z-10">
        <div class="flex items-center h-full pt-2 max-w-[70%]">
            <div class="flex items-center space-x-1 overflow-x-auto no-scrollbar h-full" id="tabs-container"></div>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-500 flex items-center mr-2 font-bold bg-gray-100 px-2 py-1 rounded-full">
                 <i class="fas fa-circle-notch fa-spin mr-1"></i> ç³»çµ±å•Ÿå‹•ä¸­...
            </div>
        </div>
    </header>
 
    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow relative bg-gray-100 flex flex-col overflow-hidden" id="main-content"></main>
 
    <!-- ================= æ¨¡æ¿å€åŸŸ ================= -->
    <div style="display:none;">
       
        <!-- 1. é¦–é é»‘æ¿æ¨¡æ¿ -->
        <div id="template-home">
             <div class="grid grid-cols-12 gap-4 h-full p-4 content-area">
                 <div class="col-span-12 md:col-span-3 flex flex-col gap-4 h-full">
                      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500 shrink-0">
                          <div class="flex items-end justify-between">
                              <div>
                                  <div id="clock-time" class="text-4xl font-mono font-bold text-gray-800 tracking-wider">00:00:00</div>
                                  <div id="clock-date" class="text-lg text-gray-500 mt-1 font-medium">Loading...</div>
                              </div>
                              <div class="text-3xl text-blue-500"><i class="far fa-clock"></i></div>
                          </div>
                      </div>
                      <div class="duty-card p-3 shrink-0">
                          <h3 class="font-bold text-blue-800 text-lg mb-2 flex items-center"><i class="fas fa-user-friends mr-2"></i>ä»Šæ—¥å€¼æ—¥ç”Ÿ</h3>
                          <div class="flex gap-2 items-center">
                              <div class="flex-1"><input type="number" id="duty-1" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                              <span class="text-blue-400 font-bold">&</span>
                              <div class="flex-1"><input type="number" id="duty-2" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#"></div>
                          </div>
                      </div>
                      <div class="sticky-note flex-grow flex flex-col p-4 relative min-h-0">
                          <div class="flex justify-between items-center mb-2 border-b border-yellow-400 pb-2 shrink-0">
                              <h3 class="font-bold text-gray-700 text-xl"><i class="fas fa-bullhorn mr-2"></i>è€å¸«å®åš€</h3>
                              <div class="flex gap-1 items-center bg-white/50 p-1 rounded">
                                  <button onclick="app.adjustFontSize(-2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-minus"></i></button>
                                  <button onclick="app.adjustFontSize(2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-plus"></i></button>
                                  <div class="w-px h-4 bg-gray-400 mx-1"></div>
                                  <input type="color" id="reminder-color" oninput="app.updateReminderStyle()" value="#000000" class="w-5 h-5 cursor-pointer border-0 p-0 rounded bg-transparent">
                                  <button id="blink-toggle" onclick="app.toggleBlink()" class="text-gray-400 hover:text-red-500 transition px-1"><i class="fas fa-bolt"></i></button>
                              </div>
                          </div>
                          <textarea id="reminder-text" oninput="app.saveSettings()" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 leading-relaxed" placeholder="åœ¨é€™è£¡è¼¸å…¥çµ¦å…¨ç­çš„æé†’äº‹é …..." style="font-size: 24px;"></textarea>
                      </div>
                 </div>
                 <div class="col-span-12 md:col-span-9 h-full flex flex-col">
                      <div class="blackboard h-full p-6 flex flex-col relative">
                          <div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-600 pb-2 shrink-0">
                              <div class="flex items-center gap-4">
                                  <h2 class="text-3xl font-bold text-white tracking-widest"><i class="fas fa-book-open mr-2"></i>è¯çµ¡ç°¿</h2>
                                  <span id="board-date-display" class="text-2xl text-yellow-300 font-mono">--/-- (ä¸€)</span>
                              </div>
                              <div class="flex gap-4 items-center">
                                  <div class="flex gap-1 bg-white/10 rounded px-2 py-1 items-center">
                                      <button onclick="app.changeContactBookFontSize(-2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>-</button>
                                      <span class="text-xs text-gray-300">å­—é«”</span>
                                      <button onclick="app.changeContactBookFontSize(2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>+</button>
                                  </div>
                                  <div class="flex gap-2">
                                      <button onclick="app.changeWeek(-1)" class="text-gray-300 hover:text-white px-2 py-1 border border-gray-500 rounded hover:bg-white/10 text-sm">ä¸Šé€±</button>
                                      <button onclick="app.changeWeek(1)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded shadow font-bold text-sm"><i class="fas fa-calendar-check mr-1"></i>æ–°çš„ä¸€é€±</button>
                                  </div>
                              </div>
                          </div>
                          <div class="flex gap-1 mb-2 overflow-x-auto shrink-0">
                              <button onclick="app.switchDay(0)" id="day-btn-0" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±ä¸€</button>
                              <button onclick="app.switchDay(1)" id="day-btn-1" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±äºŒ</button>
                              <button onclick="app.switchDay(2)" id="day-btn-2" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±ä¸‰</button>
                              <button onclick="app.switchDay(3)" id="day-btn-3" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±å››</button>
                              <button onclick="app.switchDay(4)" id="day-btn-4" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">é€±äº”</button>
                          </div>
                          <div class="flex-grow flex gap-6 overflow-hidden pt-2">
                              <div class="flex-grow flex flex-col overflow-y-auto pr-2 w-7/12" id="todo-list-container">
                                  <div id="todo-list" class="space-y-3 mb-2"></div>
                                  <div class="mb-4">
                                      <button onclick="app.addTodoItem()" class="text-yellow-400 hover:text-yellow-200 text-sm border border-dashed border-yellow-600 hover:border-yellow-400 px-3 py-1 rounded transition flex items-center"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                                  </div>
                              </div>
                              <div class="w-px bg-white/10 border-l border-dashed border-gray-500/50"></div>
                              <div class="w-5/12 flex flex-col gap-2 min-w-[200px]">
                                  <div class="bg-black/20 rounded p-2 text-center relative">
                                      <label class="block text-yellow-300 text-lg mb-1 font-bold">ä»Šæ—¥æˆèª</label>
                                      <div class="absolute top-2 right-2 flex gap-1 z-10">
                                           <button onclick="app.changeIdiomFontSize(-2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-minus"></i></button>
                                           <button onclick="app.changeIdiomFontSize(2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-plus"></i></button>
                                      </div>
                                      <input type="text" id="idiom-input" oninput="app.saveContactBook()" class="chalk-input text-2xl text-center font-bold text-yellow-100 w-full" placeholder="è¼¸å…¥æˆèª">
                                  </div>
                                  <textarea id="idiom-desc" oninput="app.saveContactBook()" class="chalk-input text-xl text-gray-200 resize-none flex-grow p-2" placeholder="åœ¨æ­¤è¼¸å…¥è§£é‡‹æˆ–ä¾‹å¥..."></textarea>
                              </div>
                          </div>
                      </div>
                 </div>
             </div>
        </div>
 
        <!-- 2. ä½œæ¥­ç®¡ç†æ¨¡æ¿ -->
        <div id="template-homework" class="w-full h-full workbook-bg">
            <div class="flex flex-col h-full ml-0">
                 <div class="p-2 md:p-3 flex flex-wrap items-center justify-between gap-2 shrink-0 no-print bg-white/80 backdrop-blur border-b border-green-100 m-2 rounded-xl shadow-sm">
                      <div class="flex items-center gap-2">
                        <div class="bg-green-500 text-white p-2 rounded-full shadow"><i class="fas fa-book text-lg"></i></div>
                        <h2 class="text-lg md:text-xl font-bold text-slate-700 cute-font">ä½œæ¥­ç¹³äº¤ç´€éŒ„ç°¿</h2>
                      </div>
                      <div class="flex flex-wrap items-center gap-2 md:gap-3">
                          <div class="flex items-center gap-2 bg-white px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-green-200 shadow-inner">
                              <i class="fas fa-calendar-alt text-green-500"></i>
                              <input type="date" id="homework-date" onchange="app.changeHomeworkDate(this.value)" class="bg-transparent border-none outline-none font-bold text-slate-600 text-sm cursor-pointer cute-font">
                          </div>
                          <div class="flex items-center gap-1 bg-red-50 px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-red-100">
                               <span class="text-sm font-bold text-red-400">å¾…è£œ:</span><span id="pending-count-badge" class="text-base font-black text-red-500 cute-font">0</span>
                          </div>
                          <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 text-sm font-bold shadow"><i class="fas fa-print"></i></button>
                      </div>
                 </div>
                 <div class="flex-grow p-2 md:p-4 overflow-y-auto scrollable-content" id="homework-scroll-area">
                      <div class="mb-3 flex flex-wrap gap-2 items-center bg-white/80 p-2 rounded-xl border border-green-100 no-print shadow-sm">
                          <span class="text-sm font-bold text-slate-500 cute-font">å¿«é€Ÿæ–°å¢ï¼š</span>
                          <input type="text" id="new-hw-type" placeholder="é …ç›®åç¨±" class="border border-green-200 rounded-full px-3 py-1 text-sm focus:outline-none focus:border-green-400 w-28 md:w-32 bg-white">
                          <button onclick="app.addHomeworkType()" class="bg-green-500 text-white hover:bg-green-600 px-3 py-1 rounded-full text-sm font-bold transition shadow-sm"><i class="fas fa-plus"></i></button>
                      </div>
                      <div id="homework-grid" class="grid grid-cols-5 md:grid-cols-6 lg:grid-cols-7 gap-2 md:gap-3 pb-4"></div>
                 </div>
            </div>
        </div>

        <!-- 3. è¨‚æ­£ç³»çµ±æ¨¡æ¿ -->
        <div id="template-correction" class="w-full h-full overflow-y-auto">
             <div class="correction-wrapper max-w-7xl mx-auto">
                <div class="title-selector mb-8">
                    <div class="title-chips-container" id="titleChipsContainer"></div>
                    <div class="add-title-inline">
                        <input type="text" id="customTitleInput" class="add-title-input" placeholder="æ–°å¢æ¨™é¡Œ..."> 
                        <button onclick="app.correction.addCustomTitle()" class="add-title-btn">æ–°å¢</button>
                    </div>
                </div>
                <div class="frames-container">
                    <div class="center-time-wrapper">
                        <div id="centerTimeDisplay" class="time-display"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="frames-grid"></div>
                </div>
            </div>
        </div>

        <!-- 4. åˆä¼‘ç™»è¨˜æ¨¡æ¿ -->
        <div id="template-nap" class="w-full h-full nap-bg overflow-y-auto">
             <div class="w-full h-full p-4 flex flex-col gap-3">
               <header class="flex items-center justify-center gap-6 pb-2 border-b border-blue-200 flex-shrink-0">
                <div class="clock-display" id="nap-clock">00:00:00</div>
                <input type="text" id="teacherMessage" oninput="app.nap.updateMessage(this.value)" class="message-input text-center max-w-2xl" placeholder="å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼" value="å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼" style="font-size:32px;font-weight:700">
               </header>
               <main class="flex-1 grid grid-cols-3 gap-4 min-h-0">
                <div class="zone green-zone" ondragover="app.nap.handleDragOver(event)" ondrop="app.nap.handleDrop(event, 'green')">
                    <span class="zone-title text-green-700"><span class="traffic-light bg-emerald-400"></span>ğŸŒŸ ä¹–å¯¶å¯¶ ğŸŒŸ</span>
                    <div class="balls-container" id="greenBalls"></div>
                </div>
                <div class="zone yellow-zone">
                    <span class="zone-title text-yellow-700"><span class="traffic-light bg-yellow-400"></span>âš ï¸ æ³¨æ„å€ âš ï¸</span>
                    <div class="grid grid-cols-1 gap-2 flex-1 min-h-0">
                      <div class="yellow-sub" ondragover="app.nap.handleDragOver(event)" ondrop="app.nap.handleDrop(event, 'yellow1')">
                       <div class="text-center text-xs font-bold text-yellow-700 mb-1">ğŸ˜… æé†’ä¸€æ¬¡</div>
                       <div class="balls-container" id="yellow1Balls"></div>
                      </div>
                      <div class="yellow-sub" ondragover="app.nap.handleDragOver(event)" ondrop="app.nap.handleDrop(event, 'yellow2')">
                       <div class="text-center text-xs font-bold text-yellow-700 mb-1">ğŸ“ ç™»è¨˜ä¸€æ¬¡</div>
                       <div class="balls-container" id="yellow2Balls"></div>
                      </div>
                      <div class="yellow-sub" ondragover="app.nap.handleDragOver(event)" ondrop="app.nap.handleDrop(event, 'yellow3')">
                       <div class="text-center text-xs font-bold text-yellow-700 mb-1">ğŸ“ğŸ“ ç™»è¨˜å…©æ¬¡</div>
                       <div class="balls-container" id="yellow3Balls"></div>
                      </div>
                    </div>
                </div>
                <div class="zone red-zone" ondragover="app.nap.handleDragOver(event)" ondrop="app.nap.handleDrop(event, 'red')">
                    <span class="zone-title text-red-700"><span class="traffic-light bg-red-400"></span>ğŸš¨ ç™»è¨˜ä¸‰æ¬¡ ğŸš¨</span>
                    <div class="balls-container" id="redBalls"></div>
                </div>
               </main>
               <div class="grid grid-cols-2 gap-4 h-24 flex-shrink-0">
                <div class="zone exempt-zone"><span class="zone-title text-orange-800 text-xs">ğŸ  ä¸å¯ç™»è¨˜å€</span>
                 <div class="flex items-center gap-1 mb-1">
                  <input type="text" id="exemptInput" class="message-input flex-1 text-xs py-1 px-2" placeholder="è¼¸å…¥åº§è™Ÿ">
                  <button onclick="app.nap.addExempt()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold px-2 py-1 rounded text-xs">æ–°å¢</button>
                 </div>
                 <div class="balls-container" id="exemptBalls" style="gap:4px;min-height:40px"></div>
                </div>
                <div class="zone next-zone"><span class="zone-title text-blue-700 text-xs">ğŸ“‹ ä¸‹æ¬¡ç™»è¨˜å€</span>
                 <div class="flex items-center gap-1 mb-1">
                  <input type="text" id="nextInput" class="message-input flex-1 text-xs py-1 px-2" placeholder="è¼¸å…¥åº§è™Ÿ">
                  <button onclick="app.nap.addNext()" class="bg-blue-400 hover:bg-blue-500 text-white font-bold px-2 py-1 rounded text-xs">æ–°å¢</button>
                 </div>
                 <div class="balls-container" id="nextBalls" style="gap:4px;min-height:40px"></div>
                </div>
               </div>
               <div class="text-center">
                <button onclick="app.nap.resetAll()" class="bg-gradient-to-r from-blue-300 to-blue-400 hover:from-blue-400 hover:to-blue-500 text-white font-bold px-6 py-3 rounded-full shadow-lg hover:scale-105 transition-transform">ğŸ”„ é‡æ–°é–‹å§‹</button>
               </div>
             </div>
        </div>

        <!-- 5. æƒåœ°æª¢æŸ¥æ¨¡æ¿ (åŠŸèƒ½ä¿®å¾©) -->
        <div id="template-cleaning" class="w-full h-full cleaning-check-bg overflow-y-auto">
            <div class="h-full flex flex-col p-4">
                <header class="bg-white shadow-md p-4 rounded-xl mb-4 flex flex-col gap-4">
                    <h1 class="text-3xl font-bold text-center text-purple-600">é›™å€åŸŸæƒåœ°æª¢æŸ¥ç³»çµ±</h1>
                    <div class="flex items-center gap-4 justify-center">
                        <div id="cleanStatusDisplay" class="flex-1 text-center py-3 rounded-lg font-bold text-lg bg-gray-100 text-gray-700">é€²è¡Œä¸­...</div>
                        <button onclick="app.cleaning.resetAll()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 whitespace-nowrap">ğŸ”„ å…¨éƒ¨é‡ç½®</button>
                    </div>
                </header>
                <div class="flex-1 flex gap-4 overflow-hidden">
                    <!-- å·¦å´ -->
                    <div class="flex-1 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden">
                        <div class="p-6 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ æ•™å®¤å€åŸŸ</h3>
                                <div class="flex gap-2">
                                    <button onclick="app.cleaning.showImport('left')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">ğŸ“¥ åŒ¯å…¥</button>
                                    <button onclick="app.cleaning.clear('left')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">ğŸ—‘ï¸ æ¸…é™¤</button>
                                    <button onclick="app.cleaning.add('left')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">â• æ–°å¢</button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto border-2 border-gray-200 rounded-lg bg-white">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-gradient-to-r from-blue-100 to-blue-200">
                                        <tr>
                                            <th class="py-2 px-2 text-left text-gray-800 font-bold border-b-2 border-blue-300 w-12">åº§è™Ÿ</th>
                                            <th class="py-2 px-2 text-left text-gray-800 font-bold border-b-2 border-blue-300 w-32">å·¥ä½œé …ç›®</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-blue-300 w-16">å·²æ‰“æƒ</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-blue-300 w-32">æª¢æŸ¥</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-blue-300 w-24">å†æ‰“æƒé€šé</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leftStudentList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- åˆ†éš”ç·š -->
                    <div class="section-divider"></div>
                    <!-- å³å´ -->
                    <div class="flex-1 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden">
                        <div class="p-6 flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ å…¬å…±å€åŸŸ</h3>
                                <div class="flex gap-2">
                                    <button onclick="app.cleaning.showImport('right')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">ğŸ“¥ åŒ¯å…¥</button>
                                    <button onclick="app.cleaning.clear('right')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">ğŸ—‘ï¸ æ¸…é™¤</button>
                                    <button onclick="app.cleaning.add('right')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">â• æ–°å¢</button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto border-2 border-gray-200 rounded-lg bg-white">
                                <table class="w-full text-sm">
                                    <thead class="sticky top-0 bg-gradient-to-r from-green-100 to-green-200">
                                        <tr>
                                            <th class="py-2 px-2 text-left text-gray-800 font-bold border-b-2 border-green-300 w-12">åº§è™Ÿ</th>
                                            <th class="py-2 px-2 text-left text-gray-800 font-bold border-b-2 border-green-300 w-32">å·¥ä½œé …ç›®</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-green-300 w-16">å·²æ‰“æƒ</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-green-300 w-32">æª¢æŸ¥</th>
                                            <th class="py-2 px-2 text-center text-gray-800 font-bold border-b-2 border-green-300 w-24">å†æ‰“æƒé€šé</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rightStudentList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 
    <!-- ä½œæ¥­å‹¾é¸ Modal -->
    <div id="homework-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-green-500 text-white p-6 flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <span class="text-green-100 text-sm font-medium uppercase tracking-wider">å­¸ç”Ÿåº§è™Ÿ</span>
                    <div class="text-5xl font-black leading-none cute-font" id="modal-student-id">--</div>
                </div>
                <button onclick="app.closeHomeworkModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors relative z-10"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-green-50 flex-grow">
                 <div id="homework-types-grid" class="grid grid-cols-2 gap-3"></div>
            </div>
            <div class="p-4 bg-white border-t border-green-100 flex justify-between items-center shrink-0">
                 <button onclick="app.markAllResolved()" class="flex items-center gap-2 text-green-600 font-bold hover:bg-green-50 px-4 py-2 rounded-lg transition-colors"><i class="fas fa-check-circle"></i>å…¨éƒ¨è£œäº¤</button>
                 <button onclick="app.closeHomeworkModal()" class="bg-slate-700 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-800 transition-colors shadow-lg">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification"></div>
 
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
 
        // æ‚¨çš„ Firebase é‡‘é‘°
        const firebaseConfig = {
            apiKey: "AIzaSyAT9VXm8gf5Pn4A1iu3xXF6X8Ve9NYlUAk", 
            authDomain: "teacherboard-9224d.firebaseapp.com",
            projectId: "teacherboard-9224d",
            storageBucket: "teacherboard-9224d.firebasestorage.app",
            messagingSenderId: "801036213120",
            appId: "1:801036213120:web:2077de68b0a74395023f65"
        };
 
        let db, docRef;
 
        window.app = {
            tabs: [ 
                { id: 'home', title: 'è¯çµ¡ç°¿', type: 'system', icon: 'fa-home' }, 
                { id: 'homework', title: 'ä½œæ¥­ç®¡ç†', type: 'system', icon: 'fa-book' },
                { id: 'correction', title: 'è¨‚æ­£ç³»çµ±', type: 'system', icon: 'fa-check-square' },
                { id: 'nap', title: 'åˆä¼‘ç™»è¨˜', type: 'system', icon: 'fa-bed' },
                { id: 'cleaning', title: 'æƒåœ°æª¢æŸ¥', type: 'system', icon: 'fa-broom' }
            ],
            settings: { 
                reminderText: '', reminderColor: '#000000', reminderFontSize: 24, reminderBlink: false, 
                duty1: '', duty2: '', contactBookFontSize: 24, idiomFontSize: 24, 
                homeworkTypes: ["ç”Ÿå­—", "åœˆçŸ­", "çŸ­é€ ", "åœ‹ç¿’", "è½è€ƒ", "åœ‹å·", "æ•¸ç¿’", "æ•¸ä½œ", "æ•¸å·", "æ•¸å…«", "ä½œæ–‡", "è¯çµ¡ç°¿", "å›æ¢", "é€±è¨˜"] 
            },
            data: { 
                contactBook: {}, 
                homework: {}, 
                correction: { selectedNumbers: Array(6).fill().map(()=>[]), correctionTitles: Array(6).fill(''), defaultTitles: ['ç”Ÿå­—','åœˆçŸ­','çŸ­é€ ','åœ‹ç¿’','æ•¸ç¿’','æ•¸ä½œ','æ•¸å·','åœ‹å·','è¯çµ¡ç°¿','åˆ·ç‰™æ“¦æ¡Œå­','è½è€ƒ','ç¤¾ç¿’','ä½œæ–‡','é€±è¨˜','æ•¸å…«','è‹±å–®','æ•¸èª²'] },
                nap: { studentPositions: {}, exemptStudents: [], nextRegisters: [], message: "å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼" },
                cleaning: { left: [], right: [] }
            },
           
            saveTimeout: null, 
            activeTabId: 'home', 
            currentWeekBase: null,
            currentDayIndex: 0, 
            currentHomeworkDate: new Date().toISOString().split('T')[0], 
            currentEditingStudent: null,
           
            init: function() {
                this.currentWeekBase = this.getMonday(new Date());
                const day = new Date().getDay();
                this.currentDayIndex = (day === 0 || day === 6) ? 0 : day - 1;
                this.renderTabs();
                this.switchTab('home');
                this.startClock();
                if(document.getElementById('homework-date')) {
                    document.getElementById('homework-date').value = this.currentHomeworkDate;
                }
 
                const statusEl = document.getElementById('sync-status');
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    docRef = doc(db, "Classrooms", "TeacherBoard_Data");
                    this.setupRealtimeListener();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    if(statusEl) statusEl.innerHTML = '<span class="text-red-500">é€£ç·šè¨­å®šéŒ¯èª¤</span>';
                }
            },
 
            getMonday: function(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },
 
            setupRealtimeListener: function() {
                const statusEl = document.getElementById('sync-status');
                if(statusEl) statusEl.innerHTML = '<i class="fas fa-cloud-download-alt animate-bounce mr-1"></i> é€£ç·šä¸­...';
 
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const parsed = docSnap.data();
                        if (parsed.settings) this.settings = { ...this.settings, ...parsed.settings };
                        if (parsed.data) {
                            let loadedData = parsed.data;
                            ['correction', 'nap', 'cleaning'].forEach(k => {
                                if (typeof loadedData[k] === 'string') {
                                    try { loadedData[k] = JSON.parse(loadedData[k]); } catch(e) {}
                                }
                            });
                            this.data = { ...this.data, ...loadedData };
                            
                            // é˜²å‘†
                            if (!this.data.correction) this.data.correction = { selectedNumbers: Array(6).fill().map(()=>[]), correctionTitles: Array(6).fill(''), defaultTitles: ['ç”Ÿå­—','åœˆçŸ­','çŸ­é€ ','åœ‹ç¿’','æ•¸ç¿’','æ•¸ä½œ','æ•¸å·','åœ‹å·','è¯çµ¡ç°¿','åˆ·ç‰™æ“¦æ¡Œå­','è½è€ƒ','ç¤¾ç¿’','ä½œæ–‡','é€±è¨˜','æ•¸å…«','è‹±å–®','æ•¸èª²'] };
                            if (!this.data.nap) this.data.nap = { studentPositions: {}, exemptStudents: [], nextRegisters: [], message: "å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼" };
                            if (!this.data.cleaning) this.data.cleaning = { left: [], right: [] };
                            if (Object.keys(this.data.nap.studentPositions).length === 0) { for(let i=1; i<=29; i++) this.data.nap.studentPositions[i] = 'green'; }
                        }
                        
                        this.refreshCurrentTab();
                        
                        if(statusEl) {
                            statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> é›²ç«¯åŒæ­¥å®Œæˆ';
                        }
                    } else {
                        // åˆå§‹åŒ–
                        this.data.nap.studentPositions = {};
                        for(let i=1; i<=29; i++) this.data.nap.studentPositions[i] = 'green';
                        this.saveToCloud();
                    }
                }, (error) => {
                    console.error("ç›£è½å¤±æ•—:", error);
                    if(statusEl) statusEl.innerHTML = '<span class="text-red-500">é€£ç·šä¸­æ–·</span>';
                });
            },
 
            saveToCloud: function() {
                if (!docRef) return;
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.className = "text-xs text-blue-600 flex items-center mr-2 font-bold bg-blue-50 px-2 py-1 rounded-full";
                    statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> ä¸Šå‚³ä¸­...';
                }
 
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(async () => {
                    try {
                        const dataToSave = JSON.parse(JSON.stringify(this.data));
                        ['correction', 'nap', 'cleaning'].forEach(k => {
                            if (dataToSave[k]) dataToSave[k] = JSON.stringify(dataToSave[k]);
                        });

                        await setDoc(docRef, { settings: this.settings, data: dataToSave }, { merge: true });
                        if (statusEl) {
                             statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                             statusEl.innerHTML = '<i class="fas fa-cloud-upload-alt mr-1"></i> å·²å„²å­˜è‡³é›²ç«¯';
                        }
                    } catch (e) {
                        console.error("å„²å­˜å¤±æ•—:", e);
                        if (statusEl) statusEl.innerHTML = '<span class="text-red-500">å„²å­˜å¤±æ•—</span>';
                    }
                }, 800);
            },
            
            refreshCurrentTab: function() {
                if (this.activeTabId === 'home') this.initHomeView();
                else if (this.activeTabId === 'homework') this.renderHomeworkGrid();
                else if (this.activeTabId === 'correction') this.correction.render();
                else if (this.activeTabId === 'nap') this.nap.render();
                else if (this.activeTabId === 'cleaning') this.cleaning.render();
            },
 
            renderTabs: function() {
                const container = document.getElementById('tabs-container');
                if(!container) return;
                container.innerHTML = '';
                this.tabs.forEach(tab => {
                    const el = document.createElement('div');
                    el.className = `tab-btn ${tab.id === this.activeTabId ? 'tab-active' : 'tab-inactive'}`;
                    el.onclick = () => this.switchTab(tab.id);
                    el.innerHTML = `<i class="fas ${tab.icon} mr-2"></i><span>${tab.title}</span>`;
                    container.appendChild(el);
                });
            },
           
            switchTab: function(tabId) {
                this.activeTabId = tabId;
                this.renderTabs();
                const main = document.getElementById('main-content');
                main.innerHTML = '';
                
                if (tabId === 'home') {
                    main.appendChild(document.getElementById('template-home').firstElementChild.cloneNode(true));
                    this.initHomeView();
                } else if (tabId === 'homework') {
                    main.appendChild(document.getElementById('template-homework').firstElementChild.cloneNode(true));
                    const dateInput = document.getElementById('homework-date');
                    if(dateInput) dateInput.value = this.currentHomeworkDate;
                    this.renderHomeworkGrid();
                } else if (tabId === 'correction') {
                    main.appendChild(document.getElementById('template-correction').firstElementChild.cloneNode(true));
                    this.correction.init();
                } else if (tabId === 'nap') {
                    main.appendChild(document.getElementById('template-nap').firstElementChild.cloneNode(true));
                    this.nap.init();
                } else if (tabId === 'cleaning') {
                    main.appendChild(document.getElementById('template-cleaning').firstElementChild.cloneNode(true));
                    this.cleaning.init();
                }
            },

            // Correction logic (integrated)
            correction: {
                init: function() {
                    this.createFrames();
                    this.createTitleChips();
                    this.render();
                    const customInput = document.getElementById('customTitleInput');
                    if(customInput) {
                        const newElement = customInput.cloneNode(true);
                        customInput.parentNode.replaceChild(newElement, customInput);
                        newElement.addEventListener('keypress', e => { if(e.key === 'Enter') app.correction.addCustomTitle(); });
                    }
                    const timeEl = document.getElementById('centerTimeDisplay');
                    if(timeEl) {
                        const updateCorrectClock = () => {
                            const d=new Date();
                            timeEl.textContent=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
                        };
                        updateCorrectClock();
                        if(this.timer) clearInterval(this.timer);
                        this.timer = setInterval(updateCorrectClock, 1000);
                    }
                },
                createFrames: function() {
                    const grid = document.getElementById('frames-grid');
                    if(!grid) return;
                    grid.innerHTML = '';
                    for(let i=0; i<6; i++) {
                        const frame = document.createElement('div');
                        frame.id = `frame-${i}`;
                        frame.className = `corr-frame frame-bg-${i}`;
                        frame.innerHTML = `<div class="frame-header"><input type="text" class="frame-title-input" placeholder="è¨‚æ­£é …ç›®" data-frame-index="${i}"><button onclick="app.correction.selectAll(${i})" class="frame-button frame-button-select">å…¨é¸</button><button onclick="app.correction.deselectAll(${i})" class="frame-button frame-button-deselect">å–æ¶ˆ</button></div><div class="corr-number-grid" id="grid-${i}"></div>`;
                        frame.querySelector('.frame-title-input').oninput = e => app.correction.updateTitle(i, e.target.value);
                        grid.appendChild(frame);
                        const numGrid = frame.querySelector(`#grid-${i}`);
                        for(let n=1; n<=29; n++) {
                            if(n===15) continue;
                            const item = document.createElement('div');
                            item.className = 'corr-number-item';
                            item.textContent = n;
                            item.dataset.number = n;
                            item.onclick = () => app.correction.toggleNumber(i, n);
                            numGrid.appendChild(item);
                        }
                    }
                },
                render: function() {
                    const data = app.data.correction;
                    if(!data) return;
                    document.querySelectorAll('.frame-title-input').forEach((input, i) => { input.value = data.correctionTitles[i] || ''; });
                    for(let f=0; f<6; f++) {
                        const frame = document.getElementById(`grid-${f}`);
                        if(frame) {
                            frame.querySelectorAll('.corr-number-item').forEach(item => {
                                const n = parseInt(item.dataset.number);
                                if (data.selectedNumbers[f] && data.selectedNumbers[f].includes(n)) { item.classList.add('selected'); } else { item.classList.remove('selected'); }
                            });
                        }
                    }
                    this.createTitleChips();
                },
                createTitleChips: function() {
                    const container = document.getElementById('titleChipsContainer');
                    if(!container) return;
                    container.innerHTML = '';
                    const titles = app.data.correction.defaultTitles || [];
                    titles.forEach((title, index) => {
                        const chip = document.createElement('div');
                        chip.className = 'title-chip';
                        chip.textContent = title;
                        chip.draggable = true;
                        chip.onclick = () => {
                            const input = document.querySelector('.frame-title-input:focus');
                            if(input) {
                                const f = parseInt(input.dataset.frameIndex);
                                input.value = title;
                                app.correction.updateTitle(f, title);
                            }
                        };
                        chip.oncontextmenu = (e) => {
                            e.preventDefault();
                            if(index >= 17) {
                                if(confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™é¡Œã€Œ${title}ã€å—ï¼Ÿ`)) {
                                    app.data.correction.defaultTitles.splice(index, 1);
                                    app.saveToCloud();
                                    app.correction.createTitleChips();
                                }
                            }
                        };
                        chip.ondragstart = (e) => e.dataTransfer.setData('text/plain', title);
                        container.appendChild(chip);
                    });
                },
                toggleNumber: function(frameIdx, num) {
                    const list = app.data.correction.selectedNumbers[frameIdx];
                    const idx = list.indexOf(num);
                    if(idx > -1) list.splice(idx, 1); else list.push(num);
                    app.saveToCloud();
                    this.render();
                },
                selectAll: function(frameIdx) {
                    app.data.correction.selectedNumbers[frameIdx] = [];
                    for(let i=1; i<=29; i++) { if(i!==15) app.data.correction.selectedNumbers[frameIdx].push(i); }
                    app.saveToCloud();
                    this.render();
                },
                deselectAll: function(frameIdx) {
                    app.data.correction.selectedNumbers[frameIdx] = [];
                    app.saveToCloud();
                    this.render();
                },
                updateTitle: function(frameIdx, val) {
                    app.data.correction.correctionTitles[frameIdx] = val;
                    app.saveToCloud();
                },
                addCustomTitle: function() {
                    const input = document.getElementById('customTitleInput');
                    const val = input.value.trim();
                    if(val) {
                        if(!app.data.correction.defaultTitles.includes(val)) {
                            app.data.correction.defaultTitles.push(val);
                            app.saveToCloud();
                            this.createTitleChips();
                        }
                        input.value = '';
                    }
                }
            },

            // Nap logic
            nap: {
                init: function() {
                    this.render();
                    const input = document.getElementById('teacherMessage');
                    if(input) input.value = app.data.nap.message || "å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼";
                    const exemptInput = document.getElementById('exemptInput');
                    if(exemptInput) {
                        const newExempt = exemptInput.cloneNode(true);
                        exemptInput.parentNode.replaceChild(newExempt, exemptInput);
                        newExempt.addEventListener('keypress', e => { if(e.key === 'Enter') this.addExempt(); });
                    }
                    const nextInput = document.getElementById('nextInput');
                    if(nextInput) {
                        const newNext = nextInput.cloneNode(true);
                        nextInput.parentNode.replaceChild(newNext, nextInput);
                        newNext.addEventListener('keypress', e => { if(e.key === 'Enter') this.addNext(); });
                    }
                    const timeEl = document.getElementById('nap-clock');
                    if(timeEl) {
                        const updateNapClock = () => { const d = new Date(); timeEl.textContent = d.toLocaleTimeString('zh-TW', {hour12: false}); };
                        updateNapClock();
                        if(this.timer) clearInterval(this.timer);
                        this.timer = setInterval(updateNapClock, 1000);
                    }
                },
                render: function() {
                    const data = app.data.nap;
                    const containers = { green: document.getElementById('greenBalls'), yellow1: document.getElementById('yellow1Balls'), yellow2: document.getElementById('yellow2Balls'), yellow3: document.getElementById('yellow3Balls'), red: document.getElementById('redBalls') };
                    Object.values(containers).forEach(c => { if(c) c.innerHTML = ''; });
                    const exemptBalls = document.getElementById('exemptBalls');
                    const nextBalls = document.getElementById('nextBalls');
                    if(exemptBalls) exemptBalls.innerHTML = '';
                    if(nextBalls) nextBalls.innerHTML = '';
                    for(let num=1; num<=29; num++) {
                        const zone = data.studentPositions[num] || 'green';
                        if(containers[zone]) containers[zone].appendChild(this.createBall(num, false, false));
                    }
                    data.exemptStudents.forEach(num => { if(exemptBalls) exemptBalls.appendChild(this.createBall(num, false, true)); });
                    data.nextRegisters.forEach(num => { if(nextBalls) nextBalls.appendChild(this.createBall(num, true, false)); });
                },
                createBall: function(num, isRemovable, isExempt) {
                    const ball = document.createElement('div');
                    ball.className = 'student-ball' + (isRemovable||isExempt?' removable-ball':'') + (isExempt?' exempt-style':'');
                    ball.textContent = num;
                    ball.dataset.student = num;
                    if(isRemovable) ball.onclick = () => this.removeNext(num);
                    else if(isExempt) ball.onclick = () => this.removeExempt(num);
                    else {
                        ball.draggable = true;
                        ball.ondragstart = (e) => { e.dataTransfer.setData('text/plain', num); e.target.classList.add('dragging'); };
                        ball.ondragend = (e) => { e.target.classList.remove('dragging'); document.querySelectorAll('.zone, .yellow-sub').forEach(z => z.classList.remove('drag-over')); };
                    }
                    return ball;
                },
                handleDragOver: function(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); },
                handleDrop: function(e, zoneId) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const studentNum = parseInt(e.dataTransfer.getData('text/plain')); if(studentNum) { app.data.nap.studentPositions[studentNum] = zoneId; app.saveToCloud(); this.render(); } },
                updateMessage: function(val) { app.data.nap.message = val; app.saveToCloud(); },
                addExempt: function() { const input = document.getElementById('exemptInput'); const num = parseInt(input.value); if(num >= 1 && num <= 29) { if(!app.data.nap.exemptStudents.includes(num)) { app.data.nap.exemptStudents.push(num); app.saveToCloud(); this.render(); } input.value = ''; } },
                removeExempt: function(num) { const idx = app.data.nap.exemptStudents.indexOf(num); if(idx > -1) { app.data.nap.exemptStudents.splice(idx, 1); app.saveToCloud(); this.render(); } },
                addNext: function() { const input = document.getElementById('nextInput'); const num = parseInt(input.value); if(num >= 1 && num <= 29) { if(!app.data.nap.nextRegisters.includes(num)) { app.data.nap.nextRegisters.push(num); app.saveToCloud(); this.render(); } input.value = ''; } },
                removeNext: function(num) { const idx = app.data.nap.nextRegisters.indexOf(num); if(idx > -1) { app.data.nap.nextRegisters.splice(idx, 1); app.saveToCloud(); this.render(); } },
                resetAll: function() { if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç‹€æ…‹å—ï¼Ÿ')) { app.data.nap.studentPositions = {}; for(let i=1; i<=29; i++) app.data.nap.studentPositions[i] = 'green'; app.data.nap.message = "å®‰éœåˆä¼‘ï¼Œå¥½å¥½ä¼‘æ¯ï¼"; app.saveToCloud(); this.render(); document.getElementById('teacherMessage').value = app.data.nap.message; } }
            },

            // Cleaning Check logic
            cleaning: {
                init: function() { this.render(); },
                render: function() {
                    const leftList = document.getElementById('leftStudentList');
                    const rightList = document.getElementById('rightStudentList');
                    if(!leftList || !rightList) return;
                    this.renderList('left', app.data.cleaning.left || []);
                    this.renderList('right', app.data.cleaning.right || []);
                    this.updateStatus();
                },
                renderList: function(side, list) {
                    const container = document.getElementById(side + 'StudentList');
                    if(list.length === 0) { container.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400 text-lg">å°šç„¡è³‡æ–™ï¼Œè«‹æ–°å¢æˆ–åŒ¯å…¥</td></tr>'; return; }
                    container.innerHTML = '';
                    list.forEach((item, index) => {
                        const tr = document.createElement('tr');
                        const l = item.completion_status === 'completed' ? 'completed' : '';
                        const r = item.inspection_status === 'passed' ? 'passed' : (item.inspection_status === 'failed' ? 'failed' : '');
                        tr.className = (item.inspection_status === 'failed' && item.recleaned_passed_status !== 'passed') ? 'border-b bg-red-50' : 'border-b hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="py-2 px-2"><input type="text" value="${item.seat}" oninput="app.cleaning.updateItem('${side}', ${index}, 'seat', this.value)" class="w-full px-2 py-1 border rounded text-xs font-bold"></td>
                            <td class="py-2 px-2"><input type="text" value="${item.task}" oninput="app.cleaning.updateItem('${side}', ${index}, 'task', this.value)" class="w-full px-2 py-1 border rounded text-xs truncate"></td>
                            <td class="py-2 px-2 text-center"><div onclick="app.cleaning.toggleStatus('${side}', ${index}, 'completion')" class="status-box ${l}">æƒ</div></td>
                            <td class="py-2 px-2 text-center"><div class="flex justify-center gap-1">
                                <div onclick="app.cleaning.toggleStatus('${side}', ${index}, 'inspection')" class="status-box ${r}">${item.inspection_status==='passed'?'é€šé':(item.inspection_status==='failed'?'æœªé€šé':'å¾…æª¢')}</div>
                                ${item.inspection_status==='failed' ? `<div onclick="app.cleaning.toggleStatus('${side}', ${index}, 'recleaned')" class="status-box ${item.recleaned_status==='recleaned'?'recleaned':''}">å·²å†æ‰“æƒ</div>` : ''}
                            </div></td>
                            <td class="py-2 px-2 text-center">${item.inspection_status==='failed' ? `<div onclick="app.cleaning.toggleStatus('${side}', ${index}, 'recleaned_passed')" class="status-box ${item.recleaned_passed_status==='passed'?'recleaned-passed':''}">é€šé</div>` : ''}</td>
                        `;
                        container.appendChild(tr);
                    });
                },
                add: function(side) {
                    const newItem = { seat: '', task: '', completion_status: 'pending', inspection_status: 'pending', recleaned_status: 'pending', recleaned_passed_status: 'pending' };
                    if(!app.data.cleaning[side]) app.data.cleaning[side] = [];
                    app.data.cleaning[side].push(newItem);
                    app.saveToCloud();
                    this.render();
                },
                clear: function(side) { if(confirm('ç¢ºå®šæ¸…é™¤æ­¤å€åŸŸæ‰€æœ‰è³‡æ–™ï¼Ÿ')) { app.data.cleaning[side] = []; app.saveToCloud(); this.render(); } },
                updateItem: function(side, index, field, value) {
                    app.data.cleaning[side][index][field] = value;
                    if(app.cleaningSaveTimeout) clearTimeout(app.cleaningSaveTimeout);
                    app.cleaningSaveTimeout = setTimeout(() => app.saveToCloud(), 1000);
                },
                toggleStatus: function(side, index, type) {
                    const item = app.data.cleaning[side][index];
                    if(type === 'completion') { item.completion_status = item.completion_status === 'pending' ? 'completed' : 'pending'; }
                    else if(type === 'inspection') {
                        const states = ['pending', 'passed', 'failed'];
                        const next = states[(states.indexOf(item.inspection_status) + 1) % 3];
                        item.inspection_status = next;
                        if(next === 'passed') { item.recleaned_status = 'pending'; item.recleaned_passed_status = 'pending'; }
                    } else if(type === 'recleaned') { if(item.inspection_status === 'failed') item.recleaned_status = item.recleaned_status === 'pending' ? 'recleaned' : 'pending'; }
                    else if(type === 'recleaned_passed') { if(item.inspection_status === 'failed') item.recleaned_passed_status = item.recleaned_passed_status === 'pending' ? 'passed' : 'pending'; }
                    app.saveToCloud();
                    this.render();
                },
                updateStatus: function() {
                    const display = document.getElementById('cleanStatusDisplay');
                    if(!display) return;
                    const allItems = [...(app.data.cleaning.left||[]), ...(app.data.cleaning.right||[])];
                    if(allItems.length === 0) { display.className = "flex-1 text-center py-3 rounded-lg font-bold text-lg bg-gray-100 text-gray-700"; display.innerHTML = "é€²è¡Œä¸­..."; return; }
                    const failed = allItems.filter(i => i.inspection_status === 'failed' && i.recleaned_passed_status !== 'passed').map(i => i.seat).filter(s => s);
                    const allPassed = allItems.every(i => i.inspection_status === 'passed' || (i.inspection_status === 'failed' && i.recleaned_passed_status === 'passed'));
                    if(allPassed) { display.className = "flex-1 text-center py-3 rounded-lg font-bold text-lg bg-green-300 text-green-800"; display.innerHTML = "âœ“ å…¨éƒ¨å®Œæˆ"; }
                    else if(failed.length > 0) { display.className = "flex-1 text-center py-3 rounded-lg font-bold text-lg bg-red-200 text-red-800"; display.innerHTML = `âš ï¸ æœªé€šé: ${failed.join(', ')}`; }
                    else { display.className = "flex-1 text-center py-3 rounded-lg font-bold text-lg bg-gray-100 text-gray-700"; display.innerHTML = "é€²è¡Œä¸­..."; }
                },
                resetAll: function() {
                    if(confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰æª¢æŸ¥ç‹€æ…‹ï¼Ÿ')) {
                        ['left', 'right'].forEach(side => {
                            if(app.data.cleaning[side]) {
                                app.data.cleaning[side].forEach(item => {
                                    item.completion_status = 'pending'; item.inspection_status = 'pending'; item.recleaned_status = 'pending'; item.recleaned_passed_status = 'pending';
                                });
                            }
                        });
                        app.saveToCloud();
                        this.render();
                    }
                },
                showImport: function(side) {
                    // Create modal dynamically
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                            <div class="p-6 border-b bg-gradient-to-r from-purple-50 to-purple-100">
                                <h3 class="text-2xl font-bold text-purple-800">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (${side === 'left' ? 'æ•™å®¤å€åŸŸ' : 'å…¬å…±å€åŸŸ'})</h3>
                            </div>
                            <div class="p-6">
                                <textarea id="importText" class="w-full h-64 px-4 py-3 border-2 border-gray-300 rounded-lg font-mono text-sm" placeholder="æ ¼å¼ï¼šåº§è™Ÿ,å·¥ä½œé …ç›®\nä¾‹å¦‚ï¼š\n1,æ“¦é»‘æ¿\n2,æ’æ¡Œæ¤…"></textarea>
                                <label class="flex items-center mt-4 cursor-pointer">
                                    <input type="checkbox" id="importReplace" class="mr-3 w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm font-semibold text-gray-700">âš ï¸ å–ä»£ç›®å‰æ‰€æœ‰è³‡æ–™</span>
                                </label>
                            </div>
                            <div class="p-6 border-t bg-gray-50 flex gap-3">
                                <button id="confirmImportBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-lg transition shadow-md">âœ“ ç¢ºå®šåŒ¯å…¥</button>
                                <button id="cancelImportBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition shadow-md">âœ• å–æ¶ˆ</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Bind events
                    document.getElementById('confirmImportBtn').onclick = () => {
                        const text = document.getElementById('importText').value;
                        const replace = document.getElementById('importReplace').checked;
                        this.processImport(side, text, replace);
                        document.body.removeChild(modal);
                    };
                    document.getElementById('cancelImportBtn').onclick = () => {
                        document.body.removeChild(modal);
                    };
                },
                processImport: function(side, text, replace) {
                    const lines = text.trim().split('\n');
                    const newItems = lines.map(line => {
                        const parts = line.split(/[,ï¼Œ]/); // Support both comma types
                        if(parts.length >= 2) {
                            return { 
                                seat: parts[0].trim(), 
                                task: parts.slice(1).join(',').trim(), 
                                completion_status: 'pending', 
                                inspection_status: 'pending', 
                                recleaned_status: 'pending', 
                                recleaned_passed_status: 'pending' 
                            };
                        }
                        return null;
                    }).filter(i => i);

                    if(newItems.length > 0) {
                        if(!app.data.cleaning[side]) app.data.cleaning[side] = [];
                        
                        if(replace) {
                            app.data.cleaning[side] = newItems;
                        } else {
                            app.data.cleaning[side].push(...newItems);
                        }
                        
                        app.saveToCloud();
                        this.render();
                        alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} ç­†è³‡æ–™`);
                    } else {
                        alert('æ²’æœ‰è®€å–åˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼');
                    }
                }
            },

            // ================= é¦–é é‚è¼¯ (ä¿æŒä¸è®Š) =================

            initHomeView: function() {
                const sets = this.settings;
                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                
                setVal('duty-1', sets.duty1);
                setVal('duty-2', sets.duty2);
                setVal('reminder-text', sets.reminderText);
                setVal('reminder-color', sets.reminderColor || '#000000');
                
                const rText = document.getElementById('reminder-text');
                if(rText) {
                    rText.style.color = sets.reminderColor;
                    rText.style.fontSize = (sets.reminderFontSize || 24) + 'px';
                    if (sets.reminderBlink) rText.classList.add('blink-active');
                }

                this.updateDateDisplay();
                this.updateDayButtons();
                this.renderTodoList();
                this.renderIdiom();
            },

            startClock: function() {
                const update = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
                    const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                    const timeEl = document.getElementById('clock-time');
                    const dateEl = document.getElementById('clock-date');
                    if(timeEl) timeEl.innerText = timeStr;
                    if(dateEl) dateEl.innerText = dateStr;
                };
                update();
                setInterval(update, 1000);
            },

            getMonday: function(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },

            updateDateDisplay: function() {
                if(!this.currentWeekBase) return;
                const targetDate = new Date(this.currentWeekBase);
                targetDate.setDate(targetDate.getDate() + this.currentDayIndex);
                const display = document.getElementById('board-date-display');
                const weekNames = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];
                if(display) {
                    display.innerText = `${targetDate.getMonth()+1}/${targetDate.getDate()} ${weekNames[targetDate.getDay()]}`;
                }
            },
            
            changeWeek: function(offset) {
                this.currentWeekBase.setDate(this.currentWeekBase.getDate() + (offset * 7));
                this.updateDateDisplay();
                this.renderTodoList();
                this.renderIdiom();
            },

            switchDay: function(idx) {
                this.currentDayIndex = idx;
                this.updateDayButtons();
                this.updateDateDisplay();
                this.renderTodoList();
                this.renderIdiom();
            },

            updateDayButtons: function() {
                for(let i=0; i<5; i++) {
                    const btn = document.getElementById(`day-btn-${i}`);
                    if(!btn) continue;
                    if(i === this.currentDayIndex) {
                        btn.className = "day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-yellow-600 text-white shadow-lg transform -translate-y-1";
                    } else {
                        btn.className = "day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20";
                    }
                }
            },

            getDateKey: function() {
                const d = new Date(this.currentWeekBase);
                d.setDate(d.getDate() + this.currentDayIndex);
                return d.toISOString().split('T')[0];
            },

            renderTodoList: function() {
                const listEl = document.getElementById('todo-list');
                if(!listEl) return;
                listEl.innerHTML = '';
                
                const dateKey = this.getDateKey();
                const items = (this.data.contactBook && this.data.contactBook[dateKey]) ? this.data.contactBook[dateKey].items : [];
                
                items.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "group flex items-center bg-white/10 p-2 rounded hover:bg-white/20 transition";
                    div.innerHTML = `
                        <div class="text-yellow-400 font-bold mr-3 text-xl w-6 text-center">${idx + 1}.</div>
                        <input type="text" class="chalk-input text-xl flex-grow ${item.done ? 'line-through text-gray-400' : ''}" 
                            value="${item.text}" oninput="app.updateTodoText(${idx}, this.value)" 
                            style="font-size: ${this.settings.contactBookFontSize || 24}px">
                        <i class="fas fa-trash-alt cb-delete-btn" onclick="app.removeTodoItem(${idx})"></i>
                    `;
                    listEl.appendChild(div);
                });
            },

            addTodoItem: function() {
                const dateKey = this.getDateKey();
                if (!this.data.contactBook) this.data.contactBook = {};
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { items: [], idiom: '', idiomDesc: '' };
                
                this.data.contactBook[dateKey].items.push({ text: '', done: false });
                this.renderTodoList();
                this.saveToCloud();
            },

            removeTodoItem: function(idx) {
                const dateKey = this.getDateKey();
                if (this.data.contactBook[dateKey]) {
                    this.data.contactBook[dateKey].items.splice(idx, 1);
                    this.renderTodoList();
                    this.saveToCloud();
                }
            },

            updateTodoText: function(idx, val) {
                const dateKey = this.getDateKey();
                if (this.data.contactBook[dateKey]) {
                    this.data.contactBook[dateKey].items[idx].text = val;
                    this.saveToCloud();
                }
            },

            changeContactBookFontSize: function(delta) {
                let size = (this.settings.contactBookFontSize || 24) + delta;
                if(size < 12) size = 12;
                if(size > 48) size = 48;
                this.settings.contactBookFontSize = size;
                this.renderTodoList();
                this.saveSettings();
            },

            renderIdiom: function() {
                const dateKey = this.getDateKey();
                const data = (this.data.contactBook && this.data.contactBook[dateKey]) || { idiom: '', idiomDesc: '' };
                const iInput = document.getElementById('idiom-input');
                const iDesc = document.getElementById('idiom-desc');
                
                if(iInput) {
                    iInput.value = data.idiom || '';
                    iInput.style.fontSize = (this.settings.idiomFontSize || 24) + 'px';
                }
                if(iDesc) {
                    iDesc.value = data.idiomDesc || '';
                    iDesc.style.fontSize = (this.settings.idiomFontSize || 24) * 0.8 + 'px';
                }
            },

            saveContactBook: function() {
                const dateKey = this.getDateKey();
                const iInput = document.getElementById('idiom-input');
                const iDesc = document.getElementById('idiom-desc');
                
                if (!this.data.contactBook) this.data.contactBook = {};
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { items: [], idiom: '', idiomDesc: '' };
                
                this.data.contactBook[dateKey].idiom = iInput ? iInput.value : '';
                this.data.contactBook[dateKey].idiomDesc = iDesc ? iDesc.value : '';
                this.saveToCloud();
            },
            
            changeIdiomFontSize: function(delta) {
                 let size = (this.settings.idiomFontSize || 24) + delta;
                 if(size < 12) size = 12;
                 if(size > 60) size = 60;
                 this.settings.idiomFontSize = size;
                 this.renderIdiom();
                 this.saveSettings();
            },

            saveSettings: function() {
                this.settings.duty1 = document.getElementById('duty-1').value;
                this.settings.duty2 = document.getElementById('duty-2').value;
                this.settings.reminderText = document.getElementById('reminder-text').value;
                this.saveToCloud();
            },
            
            updateReminderStyle: function() {
                const color = document.getElementById('reminder-color').value;
                this.settings.reminderColor = color;
                const rText = document.getElementById('reminder-text');
                if(rText) rText.style.color = color;
                this.saveToCloud();
            },
            
            adjustFontSize: function(delta) {
                let current = this.settings.reminderFontSize || 24;
                current += delta;
                if(current < 12) current = 12;
                this.settings.reminderFontSize = current;
                const rText = document.getElementById('reminder-text');
                if(rText) rText.style.fontSize = current + 'px';
                this.saveToCloud();
            },

            toggleBlink: function() {
                this.settings.reminderBlink = !this.settings.reminderBlink;
                const rText = document.getElementById('reminder-text');
                if(rText) {
                    if(this.settings.reminderBlink) rText.classList.add('blink-active');
                    else rText.classList.remove('blink-active');
                }
                this.saveToCloud();
            },

            // ================= ä½œæ¥­ç®¡ç†é‚è¼¯ =================

            changeHomeworkDate: function(date) {
                this.currentHomeworkDate = date;
                this.renderHomeworkGrid();
            },
            
            addHomeworkType: function() {
                const input = document.getElementById('new-hw-type');
                const val = input.value.trim();
                if(val && !this.settings.homeworkTypes.includes(val)) {
                    this.settings.homeworkTypes.push(val);
                    input.value = '';
                    this.saveToCloud();
                    this.renderHomeworkGrid();
                    alert(`å·²æ–°å¢ä½œæ¥­é …ç›®ï¼š${val}`);
                }
            },

            renderHomeworkGrid: function() {
                const grid = document.getElementById('homework-grid');
                if(!grid) return;
                grid.innerHTML = '';
                
                let pendingTotal = 0;
                
                for (let i = 1; i <= 30; i++) {
                    const studentId = i.toString();
                    const dayData = (this.data.homework && this.data.homework[this.currentHomeworkDate]) || {};
                    const studentData = dayData[studentId] || {}; 
                    
                    const missingItems = Object.keys(studentData).filter(key => studentData[key] === 'missing');
                    const resolvedItems = Object.keys(studentData).filter(key => studentData[key] === 'resolved');

                    const isComplete = missingItems.length === 0;
                    
                    if (!isComplete) pendingTotal++;

                    const cell = document.createElement('div');
                    cell.className = `student-grid-cell ${isComplete ? '' : 'incomplete'}`;
                    cell.onclick = () => this.openHomeworkModal(studentId);
                    
                    let statusHTML = '';
                    if (isComplete) {
                        if(resolvedItems.length > 0) {
                             statusHTML = `<div class="flex-grow flex items-center justify-center text-green-500 text-4xl opacity-80"><i class="fas fa-check-double"></i></div>`;
                        } else {
                             statusHTML = `<div class="flex-grow flex items-center justify-center text-green-100 text-4xl opacity-20"><i class="fas fa-check"></i></div>`;
                        }
                    } else {
                        statusHTML = `<div class="flex-grow flex flex-col items-center justify-center p-1 gap-1 overflow-hidden">
                            ${missingItems.map(t => `<span class="text-xs bg-red-100 text-red-600 px-1 rounded truncate w-full text-center font-bold">${t}</span>`).join('')}
                        </div>`;
                    }

                    cell.innerHTML = `
                        <div class="cell-tape"></div>
                        <div class="mt-3 text-center font-black text-xl text-gray-700 cute-font z-10">${studentId}</div>
                        ${statusHTML}
                    `;
                    grid.appendChild(cell);
                }
                
                const badge = document.getElementById('pending-count-badge');
                if(badge) badge.innerText = pendingTotal;
            },

            openHomeworkModal: function(studentId) {
                this.currentEditingStudent = studentId;
                document.getElementById('modal-student-id').innerText = studentId;
                
                const grid = document.getElementById('homework-types-grid');
                grid.innerHTML = '';
                
                const dayData = (this.data.homework && this.data.homework[this.currentHomeworkDate]) || {};
                const studentData = dayData[studentId] || {};
                
                this.settings.homeworkTypes.forEach(type => {
                    const status = studentData[type] || 'none';
                    
                    const btn = document.createElement('button');
                    let btnClass = "p-3 rounded-lg font-bold text-lg transition flex justify-between items-center shadow-sm ";
                    let iconHTML = "";
                    
                    if (status === 'missing') {
                        btnClass += "bg-red-500 text-white shadow-lg transform scale-105 ring-2 ring-red-300";
                        iconHTML = '<i class="fas fa-times-circle text-white text-xl"></i>';
                    } else if (status === 'resolved') {
                        btnClass += "bg-green-500 text-white shadow-md ring-2 ring-green-300";
                        iconHTML = '<i class="fas fa-check-circle text-white text-xl"></i>';
                    } else {
                        btnClass += "bg-gray-100 text-gray-500 hover:bg-gray-200";
                        iconHTML = '<i class="far fa-circle text-gray-300 text-xl"></i>';
                    }

                    btn.className = btnClass;
                    btn.innerHTML = `<span>${type}</span> ${iconHTML}`;
                    btn.onclick = () => this.toggleHomeworkStatus(type);
                    grid.appendChild(btn);
                });
                
                document.getElementById('homework-modal').classList.remove('hidden');
            },

            toggleHomeworkStatus: function(type) {
                const dateKey = this.currentHomeworkDate;
                if (!this.data.homework) this.data.homework = {};
                if (!this.data.homework[dateKey]) this.data.homework[dateKey] = {};
                if (!this.data.homework[dateKey][this.currentEditingStudent]) this.data.homework[dateKey][this.currentEditingStudent] = {};
                
                const currentStatus = this.data.homework[dateKey][this.currentEditingStudent][type] || 'none';
                
                let nextStatus = 'none';
                if (currentStatus === 'none') nextStatus = 'missing';
                else if (currentStatus === 'missing') nextStatus = 'resolved';
                else if (currentStatus === 'resolved') nextStatus = 'none';

                if (nextStatus === 'none') {
                    delete this.data.homework[dateKey][this.currentEditingStudent][type];
                } else {
                    this.data.homework[dateKey][this.currentEditingStudent][type] = nextStatus;
                }
                
                this.saveToCloud();
                this.openHomeworkModal(this.currentEditingStudent);
                this.renderHomeworkGrid(); 
            },

            markAllResolved: function() {
                 const dateKey = this.currentHomeworkDate;
                 if (!this.data.homework || !this.data.homework[dateKey]) return;
                 
                 const studentData = this.data.homework[dateKey][this.currentEditingStudent];
                 if (!studentData) return;

                 Object.keys(studentData).forEach(key => {
                     if (studentData[key] === 'missing') {
                         studentData[key] = 'resolved';
                     }
                 });

                 this.saveToCloud();
                 this.openHomeworkModal(this.currentEditingStudent); 
                 this.renderHomeworkGrid();
            },

            closeHomeworkModal: function() {
                document.getElementById('homework-modal').classList.add('hidden');
                this.renderHomeworkGrid();
            }
        };
        
        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>

