<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 👇 您可以在這裡更改瀏覽器最上方分頁標籤顯示的名稱 👇 -->
    <title>班級黑板</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@600&family=Mali:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
        }
        
        /* === 黑板風格 === */
        .blackboard {
            background-color: #2b3a28;
            background-image: 
                radial-gradient(#4a5d46 1px, transparent 1px),
                radial-gradient(#4a5d46 1px, transparent 1px);
            background-position: 0 0, 20px 20px;
            background-size: 40px 40px;
            box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.3);
            border: 12px solid #8B4513;
            border-radius: 8px;
            color: #fff;
            font-family: 'Noto Serif TC', serif;
        }
        .chalk-text {
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .chalk-input {
            background: transparent;
            border: none;
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            color: white;
            font-family: 'Noto Serif TC', serif;
            width: 100%;
            padding: 4px;
            transition: font-size 0.2s, height 0.2s;
        }
        .chalk-input:focus {
            outline: none;
            border-bottom: 1px solid white;
            background: rgba(255,255,255,0.1);
        }
        .cb-delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            color: #ef4444;
            margin-left: 8px;
            padding: 4px;
        }
        .group:hover .cb-delete-btn { opacity: 0.6; }
        .cb-delete-btn:hover { opacity: 1 !important; }

        /* === 便利貼 === */
        .sticky-note {
            background-color: #fef08a;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            border-top: 10px solid rgba(255,255,0,0.3);
        }

        /* === 值日生卡片 === */
        .duty-card {
            background-color: #e0f2fe; /* blue-100 */
            border-left: 4px solid #3b82f6; /* blue-500 */
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        /* === 筆記本 === */
        .memo-pad {
            background-color: #fffbeb;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 2rem;
            line-height: 2rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 100%;
            overflow-y: auto;
            border-radius: 0.5rem;
        }
        .memo-textarea {
            width: 100%; height: 100%; background: transparent; border: none;
            resize: none; outline: none; font-size: 1.25rem; line-height: 2rem; color: #374151;
        }

        /* === 動畫 === */
        @keyframes blinker { 50% { opacity: 0.3; color: red; } }
        .blink-active { animation: blinker 1.5s linear infinite; font-weight: bold; }

        /* === 卷軸與佈局 === */
        .content-area { height: calc(100vh - 60px); overflow-y: hidden; }
        .scrollable-content { height: 100%; overflow-y: auto; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* === 分頁標籤 === */
        .tab-btn {
            white-space: nowrap;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .tab-active { background-color: #f3f4f6; color: #1e40af; border-bottom: 3px solid #1e40af; }
        .tab-inactive { background-color: white; color: #64748b; border-bottom: 3px solid transparent; }
        .tab-inactive:hover { background-color: #f1f5f9; }
        
        .tab-close-btn {
            width: 20px; height: 20px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            margin-left: 8px;
            color: #94a3b8;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-close-btn:hover {
            background-color: #ef4444;
            color: white;
        }

        /* === 極簡清新風格 (Simple Fresh Style) === */
        .workbook-bg {
            background-color: #ffffff;
            /* 方格紙背景 */
            background-image: 
                linear-gradient(rgba(200, 220, 200, 0.4) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 220, 200, 0.4) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        .student-grid-cell {
            min-height: 90px;
            display: flex; flex-direction: column;
            border-radius: 10px;
            transition: all 0.2s; position: relative; cursor: pointer; overflow: hidden;
            
            background-color: #22c55e;
            border: 2px solid #ffffff;
            box-shadow: 0 3px 5px rgba(0,0,0,0.12);
        }
        
        .student-grid-cell:hover {
            transform: translateY(-2px);
            background-color: #16a34a;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
        
        /* 裝飾：上方膠帶 */
        .cell-tape {
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            width: 30px;
            height: 15px;
            background-color: rgba(255,255,255,0.4);
            z-index: 0;
        }
        
        .cute-font { font-family: 'Mali', 'Noto Sans TC', cursive; }

        @media print {
            body { overflow: auto; background: white; }
            header, .no-print { display: none !important; }
            .print-visible { display: block !important; }
            .content-area { height: auto; overflow: visible; }
            #homework-grid { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 頂部導覽列 -->
    <header class="h-[60px] bg-white border-b shadow-sm flex items-center px-4 justify-between shrink-0 z-10">
        <div class="flex items-center space-x-1 overflow-x-auto max-w-[70%] no-scrollbar h-full pt-2" id="tabs-container">
            <!-- JS 生成 -->
        </div>
        
        <div class="flex items-center gap-2">
            <!-- 狀態指示燈 -->
            <div id="sync-status" class="text-xs text-gray-500 flex items-center mr-2 font-bold bg-gray-100 px-2 py-1 rounded-full">
                <i class="fas fa-circle-notch fa-spin mr-1"></i> 連線中...
            </div>
            <button onclick="app.openAddTabModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded shadow text-sm flex items-center transition">
                <i class="fas fa-plus mr-1"></i> 新增
            </button>
        </div>
    </header>

    <!-- 主內容區 -->
    <main class="flex-grow relative bg-gray-100 flex flex-col" id="main-content">
        <!-- 內容動態生成或切換 -->
    </main>

    <!-- 隱藏的模板區域 -->
    <div style="display:none;">
        
        <!-- 1. 首頁模板 -->
        <div id="template-home">
             <div class="grid grid-cols-12 gap-4 h-full p-4">
                <!-- 左側：時鐘、值日生與提醒 (3/12) -->
                <div class="col-span-12 md:col-span-3 flex flex-col gap-4 h-full">
                    
                    <!-- 1. 時鐘 -->
                    <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500 shrink-0">
                        <div class="flex items-end justify-between">
                            <div>
                                <div id="clock-time" class="text-4xl font-mono font-bold text-gray-800 tracking-wider">00:00:00</div>
                                <div id="clock-date" class="text-lg text-gray-500 mt-1 font-medium">Loading...</div>
                            </div>
                            <div class="text-3xl text-blue-500"><i class="far fa-clock"></i></div>
                        </div>
                    </div>

                    <!-- 2. 今日值日生 -->
                    <div class="duty-card p-3 shrink-0">
                        <h3 class="font-bold text-blue-800 text-lg mb-2 flex items-center">
                            <i class="fas fa-user-friends mr-2"></i>今日值日生
                        </h3>
                        <div class="flex gap-2 items-center">
                            <div class="flex-1">
                                <input type="number" id="duty-1" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#">
                            </div>
                            <span class="text-blue-400 font-bold">&</span>
                            <div class="flex-1">
                                <input type="number" id="duty-2" min="1" max="50" oninput="app.saveSettings()" class="w-full text-center text-2xl font-bold bg-white border border-blue-300 rounded py-1 focus:ring-2 focus:ring-blue-400 focus:outline-none text-blue-900" placeholder="#">
                            </div>
                        </div>
                    </div>

                    <!-- 3. 老師叮嚀 -->
                    <div class="sticky-note flex-grow flex flex-col p-4 relative min-h-0">
                        <div class="flex justify-between items-center mb-2 border-b border-yellow-400 pb-2 shrink-0">
                            <h3 class="font-bold text-gray-700 text-xl"><i class="fas fa-bullhorn mr-2"></i>老師叮嚀</h3>
                            <div class="flex gap-1 items-center bg-white/50 p-1 rounded">
                                <button onclick="app.adjustFontSize(-2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-minus"></i></button>
                                <button onclick="app.adjustFontSize(2)" class="text-gray-600 px-1 hover:text-black"><i class="fas fa-plus"></i></button>
                                <div class="w-px h-4 bg-gray-400 mx-1"></div>
                                <input type="color" id="reminder-color" oninput="app.updateReminderStyle()" value="#000000" class="w-5 h-5 cursor-pointer border-0 p-0 rounded bg-transparent">
                                <button id="blink-toggle" onclick="app.toggleBlink()" class="text-gray-400 hover:text-red-500 transition px-1"><i class="fas fa-bolt"></i></button>
                            </div>
                        </div>
                        <textarea id="reminder-text" oninput="app.saveSettings()" class="w-full h-full bg-transparent border-none resize-none focus:ring-0 text-xl leading-relaxed" placeholder="在這裡輸入給全班的提醒事項..." style="font-size: 24px;"></textarea>
                    </div>
                </div>

                <!-- 右側：黑板聯絡簿 (9/12) -->
                <div class="col-span-12 md:col-span-9 h-full flex flex-col">
                    <div class="blackboard h-full p-6 flex flex-col relative">
                        <!-- 黑板頂部 -->
                        <div class="flex flex-wrap justify-between items-center mb-4 border-b border-gray-600 pb-2 shrink-0">
                            <div class="flex items-center gap-4">
                                <h2 class="text-3xl font-bold text-white tracking-widest"><i class="fas fa-book-open mr-2"></i>聯絡簿</h2>
                                <span id="board-date-display" class="text-2xl text-yellow-300 font-mono">2023/--/-- (一)</span>
                            </div>
                            <div class="flex gap-4 items-center">
                                <div class="flex gap-1 bg-white/10 rounded px-2 py-1 items-center">
                                    <button onclick="app.changeContactBookFontSize(-2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>-</button>
                                    <span class="text-xs text-gray-300">字體</span>
                                    <button onclick="app.changeContactBookFontSize(2)" class="text-white hover:text-yellow-300 px-1 text-sm"><i class="fas fa-font"></i>+</button>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.changeWeek(-1)" class="text-gray-300 hover:text-white px-2 py-1 border border-gray-500 rounded hover:bg-white/10 text-sm">上週</button>
                                    <button onclick="app.changeWeek(1)" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded shadow font-bold text-sm"><i class="fas fa-calendar-check mr-1"></i>新的一週</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 星期按鈕 -->
                        <div class="flex gap-1 mb-2 overflow-x-auto shrink-0">
                            <button onclick="app.switchDay(0)" id="day-btn-0" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週一</button>
                            <button onclick="app.switchDay(1)" id="day-btn-1" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週二</button>
                            <button onclick="app.switchDay(2)" id="day-btn-2" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週三</button>
                            <button onclick="app.switchDay(3)" id="day-btn-3" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週四</button>
                            <button onclick="app.switchDay(4)" id="day-btn-4" class="day-btn flex-1 py-1 rounded-t text-sm font-bold transition bg-white/10 text-gray-300 hover:bg-white/20">週五</button>
                        </div>
                        
                        <!-- 內容區 (左右分欄) -->
                        <div class="flex-grow flex gap-6 overflow-hidden pt-2">
                            <!-- 左欄：聯絡事項 -->
                            <div class="flex-grow flex flex-col overflow-y-auto pr-2 w-7/12">
                                <div id="todo-list" class="space-y-3 mb-2"></div>
                                <div class="mb-4">
                                    <button onclick="app.addTodoItem()" class="text-yellow-400 hover:text-yellow-200 text-sm border border-dashed border-yellow-600 hover:border-yellow-400 px-3 py-1 rounded transition flex items-center"><i class="fas fa-plus mr-1"></i> 新增項目</button>
                                </div>
                            </div>

                            <!-- 分隔線 -->
                            <div class="w-px bg-white/10 border-l border-dashed border-gray-500/50"></div>

                            <!-- 右欄：成語專區 -->
                            <div class="w-5/12 flex flex-col gap-2 min-w-[200px]">
                                <div class="bg-black/20 rounded p-2 text-center relative">
                                    <label class="block text-yellow-300 text-lg mb-1 font-bold">今日成語</label>
                                    
                                    <!-- 成語字體調整按鈕 -->
                                    <div class="absolute top-2 right-2 flex gap-1 z-10">
                                        <button onclick="app.changeIdiomFontSize(-2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-minus"></i></button>
                                        <button onclick="app.changeIdiomFontSize(2)" class="text-white/70 hover:text-white bg-black/30 rounded px-1.5 py-0.5 text-xs transition"><i class="fas fa-plus"></i></button>
                                    </div>

                                    <input type="text" id="idiom-input" oninput="app.saveContactBook()" class="chalk-input text-2xl text-center font-bold text-yellow-100 w-full" placeholder="輸入成語">
                                </div>
                                <textarea id="idiom-desc" oninput="app.saveContactBook()" class="chalk-input text-xl text-gray-200 resize-none flex-grow p-2" placeholder="在此輸入解釋或例句..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 作業管理模板 -->
        <div id="template-homework" class="w-full h-full workbook-bg">
            <div class="flex flex-col h-full ml-0">
                <!-- 工具列 -->
                <div class="p-2 md:p-3 flex flex-wrap items-center justify-between gap-2 shrink-0 no-print bg-white/80 backdrop-blur border-b border-green-100 m-2 rounded-xl shadow-sm">
                    <div class="flex items-center gap-2">
                        <div class="bg-green-500 text-white p-2 rounded-full shadow"><i class="fas fa-book text-lg"></i></div>
                        <h2 class="text-lg md:text-xl font-bold text-slate-700 cute-font">作業繳交紀錄簿</h2>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-2 md:gap-3">
                        <div class="flex items-center gap-2 bg-white px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-green-200 shadow-inner">
                            <i class="fas fa-calendar-alt text-green-500"></i>
                            <input type="date" id="homework-date" onchange="app.changeHomeworkDate(this.value)" class="bg-transparent border-none outline-none font-bold text-slate-600 text-sm cursor-pointer cute-font">
                        </div>
                        <div class="flex items-center gap-1 bg-red-50 px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-red-100">
                            <span class="text-sm font-bold text-red-400">待補:</span>
                            <span id="pending-count-badge" class="text-base font-black text-red-500 cute-font">0</span>
                        </div>
                        <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 text-sm font-bold shadow">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>

                <!-- 學生方格區 -->
                <div class="flex-grow p-2 md:p-4 overflow-y-auto scrollable-content" id="homework-scroll-area">
                    <!-- 新增項目列 -->
                    <div class="mb-3 flex flex-wrap gap-2 items-center bg-white/80 p-2 rounded-xl border border-green-100 no-print shadow-sm">
                        <span class="text-sm font-bold text-slate-500 cute-font">快速新增：</span>
                        <input type="text" id="new-hw-type" placeholder="項目名稱" class="border border-green-200 rounded-full px-3 py-1 text-sm focus:outline-none focus:border-green-400 w-28 md:w-32 bg-white">
                        <button onclick="app.addHomeworkType()" class="bg-green-500 text-white hover:bg-green-600 px-3 py-1 rounded-full text-sm font-bold transition shadow-sm"><i class="fas fa-plus"></i></button>
                    </div>

                    <!-- 網格 -->
                    <div id="homework-grid" class="grid grid-cols-7 gap-2 md:gap-3 pb-4">
                        <!-- JS 生成 -->
                    </div>

                    <!-- 列印專用視圖 (隱藏) -->
                    <div id="print-view" class="hidden print-visible p-8 bg-white">
                        <div class="text-center mb-8 border-b-2 border-black pb-4">
                            <h1 class="text-4xl font-black mb-2 tracking-widest">作業缺交統計表</h1>
                            <p class="text-xl" id="print-date">日期：2023/--/--</p>
                        </div>
                        <table class="w-full text-left border-collapse border border-black" id="print-table">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border border-black px-4 py-2 text-xl w-24 text-center">座號</th>
                                    <th class="border border-black px-4 py-2 text-xl">缺交紀錄</th>
                                </tr>
                            </thead>
                            <tbody id="print-table-body"></tbody>
                        </table>
                        <div class="mt-8 flex justify-between items-end">
                            <div class="text-sm text-gray-500">老師簽名：________________</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 作業編輯 Modal -->
    <div id="homework-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-green-500 text-white p-6 flex justify-between items-center relative overflow-hidden">
                <div class="relative z-10">
                    <span class="text-green-100 text-sm font-medium uppercase tracking-wider">學生座號</span>
                    <div class="text-5xl font-black leading-none cute-font" id="modal-student-id">--</div>
                </div>
                <button onclick="app.closeHomeworkModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition-colors relative z-10"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-green-50">
                <div class="mb-4 bg-white p-3 rounded-lg text-sm text-gray-600 flex gap-2 border border-green-100 shadow-sm">
                    <i class="fas fa-hand-pointer text-green-400 mt-0.5"></i>
                    點擊切換：<span class="text-red-500 font-bold">缺交</span> &rarr; <span class="text-green-600 font-bold">已補</span> &rarr; 清除
                </div>
                <div id="homework-types-grid" class="grid grid-cols-2 gap-3">
                    <!-- JS 生成按鈕 -->
                </div>
            </div>
            <div class="p-4 bg-white border-t border-green-100 flex justify-between items-center">
                <button onclick="app.markAllResolved()" class="flex items-center gap-2 text-green-600 hover:text-green-700 font-bold px-4 py-2 rounded-lg hover:bg-green-50 transition-colors">
                    <i class="fas fa-check-circle"></i> 一鍵全部補交
                </button>
                <button onclick="app.closeHomeworkModal()" class="bg-slate-700 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-800 transition-colors shadow-lg">完成</button>
            </div>
        </div>
    </div>

    <!-- 新增分頁 Modal -->
    <div id="modal-add-tab" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg p-6 w-[600px] shadow-xl transform scale-100 transition-transform">
            <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-plus-circle text-blue-500 mr-2"></i> 新增分頁</h3>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">請選擇類型：</label>
                <div class="grid grid-cols-3 gap-3">
                    <label class="cursor-pointer border rounded-lg p-3 hover:bg-blue-50 hover:border-blue-300 transition text-center group relative">
                        <input type="radio" name="tab-type" value="url" checked onchange="app.toggleTabTypeInput()" class="hidden peer">
                        <div class="text-3xl mb-2 text-gray-400 peer-checked:text-blue-600 group-hover:text-blue-500"><i class="fas fa-globe"></i></div>
                        <div class="text-sm font-bold text-gray-600 peer-checked:text-blue-800">網頁連結</div>
                        <div class="absolute top-2 right-2 text-blue-600 opacity-0 peer-checked:opacity-100"><i class="fas fa-check-circle"></i></div>
                    </label>
                    <label class="cursor-pointer border rounded-lg p-3 hover:bg-green-50 hover:border-green-300 transition text-center group relative">
                        <input type="radio" name="tab-type" value="memo" onchange="app.toggleTabTypeInput()" class="hidden peer">
                        <div class="text-3xl mb-2 text-gray-400 peer-checked:text-green-600 group-hover:text-green-500"><i class="fas fa-sticky-note"></i></div>
                        <div class="text-sm font-bold text-gray-600 peer-checked:text-green-800">自訂筆記</div>
                        <div class="absolute top-2 right-2 text-green-600 opacity-0 peer-checked:opacity-100"><i class="fas fa-check-circle"></i></div>
                    </label>
                    <label class="cursor-pointer border rounded-lg p-3 hover:bg-gray-50 hover:border-gray-300 transition text-center group relative">
                        <input type="radio" name="tab-type" value="embed" onchange="app.toggleTabTypeInput()" class="hidden peer">
                        <div class="text-3xl mb-2 text-gray-400 peer-checked:text-gray-600 group-hover:text-gray-500"><i class="fas fa-code"></i></div>
                        <div class="text-sm font-bold text-gray-600 peer-checked:text-gray-800">內嵌程式碼</div>
                        <div class="absolute top-2 right-2 text-gray-600 opacity-0 peer-checked:opacity-100"><i class="fas fa-check-circle"></i></div>
                    </label>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">分頁標題</label>
                    <input type="text" id="new-tab-title" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" placeholder="例如：我的地圖">
                </div>
                <div id="input-group-url">
                    <label class="block text-sm font-medium text-gray-700">網址 (URL)</label>
                    <input type="url" id="new-tab-url" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200" placeholder="https://...">
                    <div class="mt-3 flex items-start">
                        <div class="flex items-center h-5"><input id="use-proxy" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"></div>
                        <div class="ml-3 text-sm">
                            <label for="use-proxy" class="font-medium text-gray-700">嘗試強制嵌入 (代理模式)</label>
                            <p class="text-gray-500 text-xs">適用於維基百科等靜態網站。不支援需要登入的網站。</p>
                        </div>
                    </div>
                </div>
                <div id="input-group-memo" class="hidden p-3 bg-green-50 rounded border border-green-100"><p class="text-sm text-green-800">建立一個空白筆記分頁。</p></div>
                <div id="input-group-embed" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">HTML 程式碼</label>
                    <textarea id="new-tab-embed-code" rows="5" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm font-mono text-sm" placeholder="<iframe src='...'></iframe>"></textarea>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
                <button onclick="app.closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">取消</button>
                <button onclick="app.addTab()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">新增</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase State
        let db, auth, user;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = {
            // 資料狀態
            tabs: [
                { id: 'home', title: '首頁', type: 'system', icon: 'fa-home' },
                { id: 'homework', title: '作業管理', type: 'system', icon: 'fa-book' }
            ],
            settings: {
                reminderText: '',
                reminderColor: '#000000',
                reminderFontSize: 24,
                reminderBlink: false,
                duty1: '',
                duty2: '',
                contactBookFontSize: 24,
                idiomFontSize: 24,
                homeworkTypes: ["生字", "圈短", "短造", "國習", "聽考", "國卷", "數習", "數作", "數卷", "數八", "作文", "聯絡簿", "回條", "週記"]
            },
            data: {
                contactBook: {}, 
                homework: {}, 
                memos: {} 
            },
            saveTimeout: null, 
            
            // 執行時變數
            activeTabId: 'home',
            currentWeekBase: null, 
            currentDayIndex: 0,
            currentHomeworkDate: new Date().toISOString().split('T')[0],
            currentEditingStudent: null,
            isFirebaseReady: false,
            
            // 初始化
            init: async function() {
                // Initialize Firebase
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const firebaseApp = initializeApp(firebaseConfig);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (u) => {
                        user = u;
                        if (user) {
                            this.isFirebaseReady = true;
                            this.setupRealtimeListener();
                        }
                    });
                } catch (e) {
                    console.error("Firebase init failed:", e);
                    // Fallback to local storage if needed, but primary is cloud
                }

                // 設定日期
                this.currentWeekBase = this.getMonday(new Date());
                const day = new Date().getDay();
                this.currentDayIndex = (day === 0 || day === 6) ? 0 : day - 1; 
                
                this.renderTabs();
                this.switchTab('home');
                this.startClock();
                document.getElementById('homework-date').value = this.currentHomeworkDate;
            },

            setupRealtimeListener: function() {
                const statusEl = document.getElementById('sync-status');
                if(statusEl) statusEl.innerHTML = '<i class="fas fa-cloud-download-alt animate-bounce mr-1"></i> 同步資料中...';

                // Listen to the user's dashboard document
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'dashboard_v1'), (docSnap) => {
                    if (docSnap.exists()) {
                        const parsed = docSnap.data();
                        
                        // Merge Data (Remote wins)
                        if (parsed.tabs) {
                             // Preserve system tabs, merge others
                             const sysTabs = this.tabs.filter(t => t.type === 'system');
                             const remoteTabs = parsed.tabs;
                             // Filter out duplicates based on ID
                             const uniqueRemote = remoteTabs.filter(rt => !sysTabs.some(st => st.id === rt.id));
                             this.tabs = [...sysTabs, ...uniqueRemote];
                        }
                        if (parsed.settings) this.settings = { ...this.settings, ...parsed.settings };
                        if (parsed.data) this.data = { ...this.data, ...parsed.data };

                        // Re-render active view to show changes
                        if (this.activeTabId === 'home') this.initHomeView();
                        if (this.activeTabId === 'homework') this.renderHomeworkGrid();
                        if (this.tabs.some(t => t.id === this.activeTabId)) this.renderTabs();

                        if(statusEl) {
                             statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                             statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> 雲端同步完成';
                        }
                    } else {
                        // No data yet, save initial state
                        this.saveToCloud();
                    }
                }, (error) => {
                    console.error("Snapshot error:", error);
                    if(statusEl) {
                         statusEl.className = "text-xs text-red-600 flex items-center mr-2 font-bold bg-red-50 px-2 py-1 rounded-full";
                         statusEl.innerHTML = '<i class="fas fa-times-circle mr-1"></i> 連線錯誤';
                    }
                });
            },

            saveToCloud: function() {
                if (!this.isFirebaseReady || !user) return;
                
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.className = "text-xs text-blue-600 flex items-center mr-2 font-bold bg-blue-50 px-2 py-1 rounded-full";
                    statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> 上傳中...';
                }

                if (this.saveTimeout) clearTimeout(this.saveTimeout);

                this.saveTimeout = setTimeout(async () => {
                    try {
                        const payload = {
                            tabs: this.tabs.filter(t => t.type !== 'system'),
                            settings: this.settings,
                            data: this.data
                        };
                        
                        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'dashboard_v1'), payload, { merge: true });
                        
                        if (statusEl) {
                            statusEl.className = "text-xs text-green-700 flex items-center mr-2 font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200";
                            statusEl.innerHTML = '<i class="fas fa-cloud-upload-alt mr-1"></i> 已儲存至雲端';
                        }
                    } catch (e) {
                        console.error("Cloud save failed:", e);
                        if (statusEl) statusEl.innerHTML = '<span class="text-red-500">上傳失敗</span>';
                    }
                }, 500);
            },

            // Alias for old calls
            saveToStorage: function() { this.saveToCloud(); },
            saveSettings: function() {
                this.settings.duty1 = document.getElementById('duty-1').value;
                this.settings.duty2 = document.getElementById('duty-2').value;
                this.settings.reminderText = document.getElementById('reminder-text').value;
                this.saveToCloud();
            },

            getMonday: function(d) {
                d = new Date(d);
                const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },
            formatDate: function(date) { return date.toISOString().split('T')[0]; },

            // === Tab 管理 ===
            renderTabs: function() {
                const container = document.getElementById('tabs-container');
                container.innerHTML = '';
                this.tabs.forEach(tab => {
                    const el = document.createElement('div');
                    el.className = `tab-btn ${tab.id === this.activeTabId ? 'tab-active' : 'tab-inactive'}`;
                    el.onclick = () => this.switchTab(tab.id);
                    let iconHtml = `<i class="fas ${tab.icon || 'fa-file'} mr-2"></i>`;
                    let closeHtml = tab.type === 'system' ? '' : `<div class="tab-close-btn" onclick="event.stopPropagation(); app.removeTab('${tab.id}')"><i class="fas fa-times"></i></div>`;
                    el.innerHTML = `${iconHtml}<span>${tab.title}</span>${closeHtml}`;
                    container.appendChild(el);
                });
            },
            switchTab: function(tabId) {
                this.activeTabId = tabId;
                this.renderTabs();
                const main = document.getElementById('main-content');
                main.innerHTML = '';
                const tab = this.tabs.find(t => t.id === tabId);
                
                if (tabId === 'home') {
                    main.appendChild(document.getElementById('template-home').firstElementChild.cloneNode(true));
                    this.initHomeView();
                } else if (tabId === 'homework') {
                    main.appendChild(document.getElementById('template-homework').firstElementChild.cloneNode(true));
                    this.renderHomeworkGrid();
                } else if (tab.type === 'url') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'w-full h-full flex flex-col bg-white';
                    wrapper.innerHTML = `
                        <div class="h-10 bg-gray-100 border-b flex items-center px-4 justify-between shrink-0 text-sm">
                            <span class="truncate text-gray-500 w-3/4">${tab.url}</span>
                            <a href="${tab.url}" target="_blank" class="text-blue-500 hover:underline">在新視窗開啟</a>
                        </div>
                        <iframe src="${tab.url}" class="flex-grow w-full border-none" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                    `;
                    main.appendChild(wrapper);
                } else if (tab.type === 'memo') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'w-full h-full p-6 bg-gray-200';
                    const content = this.data.memos[tabId] || '';
                    wrapper.innerHTML = `<div class="memo-pad h-full"><textarea class="memo-textarea" oninput="app.data.memos['${tabId}'] = this.value; app.saveToCloud()" placeholder="請在此輸入筆記...">${content}</textarea></div>`;
                    main.appendChild(wrapper);
                } else if (tab.type === 'embed') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'w-full h-full bg-white';
                    wrapper.innerHTML = `<iframe class="w-full h-full border-none" srcdoc="${tab.content.replace(/"/g, '&quot;')}" sandbox="allow-scripts allow-same-origin"></iframe>`;
                    main.appendChild(wrapper);
                }
            },
            openAddTabModal: function() { document.getElementById('modal-add-tab').classList.remove('hidden'); },
            closeModal: function() { document.getElementById('modal-add-tab').classList.add('hidden'); },
            toggleTabTypeInput: function() {
                const type = document.querySelector('input[name="tab-type"]:checked').value;
                document.getElementById('input-group-url').classList.toggle('hidden', type !== 'url');
                document.getElementById('input-group-memo').classList.toggle('hidden', type !== 'memo');
                document.getElementById('input-group-embed').classList.toggle('hidden', type !== 'embed');
            },
            addTab: function() {
                const type = document.querySelector('input[name="tab-type"]:checked').value;
                const title = document.getElementById('new-tab-title').value || '新分頁';
                const id = 'tab_' + Date.now();
                let newTab = { id, title, type };
                
                if (type === 'url') {
                    let url = document.getElementById('new-tab-url').value;
                    if (!url) return alert('請輸入網址');
                    newTab.url = url;
                    newTab.icon = 'fa-globe';
                } else if (type === 'memo') {
                    newTab.icon = 'fa-sticky-note';
                    this.data.memos[id] = '';
                } else if (type === 'embed') {
                    newTab.content = document.getElementById('new-tab-embed-code').value;
                    newTab.icon = 'fa-code';
                }
                this.tabs.push(newTab);
                this.renderTabs();
                this.switchTab(id);
                this.closeModal();
                this.saveToCloud();
            },
            removeTab: function(id) {
                if (!confirm('確定要刪除此分頁嗎？')) return;
                this.tabs = this.tabs.filter(t => t.id !== id);
                if (this.data.memos[id]) delete this.data.memos[id];
                if (this.activeTabId === id) this.switchTab('home');
                else this.renderTabs();
                this.saveToCloud();
            },

            // === 首頁功能 ===
            initHomeView: function() {
                document.getElementById('duty-1').value = this.settings.duty1 || '';
                document.getElementById('duty-2').value = this.settings.duty2 || '';
                const reminder = document.getElementById('reminder-text');
                reminder.value = this.settings.reminderText || '';
                reminder.style.fontSize = this.settings.reminderFontSize + 'px';
                reminder.style.color = this.settings.reminderColor;
                document.getElementById('reminder-color').value = this.settings.reminderColor;
                if(this.settings.reminderBlink) reminder.classList.add('blink-active');
                
                // Fix Idiom Font Size
                if(!this.settings.idiomFontSize) this.settings.idiomFontSize = 24;
                this.applyIdiomFontSize();
                this.renderContactBook();
            },
            startClock: function() {
                const update = () => {
                    const now = new Date();
                    const timeEl = document.getElementById('clock-time');
                    const dateEl = document.getElementById('clock-date');
                    if (timeEl) timeEl.textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
                    if (dateEl) dateEl.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                };
                setInterval(update, 1000);
                update();
            },
            adjustFontSize: function(delta) {
                this.settings.reminderFontSize += delta;
                document.getElementById('reminder-text').style.fontSize = this.settings.reminderFontSize + 'px';
                this.saveToCloud();
            },
            updateReminderStyle: function() {
                this.settings.reminderColor = document.getElementById('reminder-color').value;
                document.getElementById('reminder-text').style.color = this.settings.reminderColor;
                this.saveToCloud();
            },
            toggleBlink: function() {
                this.settings.reminderBlink = !this.settings.reminderBlink;
                const el = document.getElementById('reminder-text');
                if (this.settings.reminderBlink) el.classList.add('blink-active');
                else el.classList.remove('blink-active');
                this.saveToCloud();
            },
            // 聯絡簿
            changeWeek: function(delta) {
                this.currentWeekBase.setDate(this.currentWeekBase.getDate() + (delta * 7));
                this.renderContactBook();
            },
            switchDay: function(index) {
                this.currentDayIndex = index;
                this.renderContactBook();
            },
            getCurrentBoardDateKey: function() {
                const d = new Date(this.currentWeekBase);
                d.setDate(d.getDate() + this.currentDayIndex);
                return this.formatDate(d);
            },
            renderContactBook: function() {
                for(let i=0; i<5; i++) {
                    const btn = document.getElementById(`day-btn-${i}`);
                    if (i === this.currentDayIndex) {
                        btn.classList.remove('bg-white/10', 'text-gray-300');
                        btn.classList.add('bg-blue-600', 'text-white', 'scale-110');
                    } else {
                        btn.classList.add('bg-white/10', 'text-gray-300');
                        btn.classList.remove('bg-blue-600', 'text-white', 'scale-110');
                    }
                }
                const dateKey = this.getCurrentBoardDateKey();
                const d = new Date(dateKey);
                document.getElementById('board-date-display').textContent = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} (${['日','一','二','三','四','五','六'][d.getDay()]})`;
                
                const dayData = this.data.contactBook[dateKey] || { todos: [], idiom: '', idiomDesc: '' };
                document.getElementById('idiom-input').value = dayData.idiom || '';
                document.getElementById('idiom-desc').value = dayData.idiomDesc || '';

                const list = document.getElementById('todo-list');
                list.innerHTML = '';
                (dayData.todos || []).forEach((todo, idx) => {
                    const row = document.createElement('div');
                    row.className = 'group flex items-center mb-1';
                    row.innerHTML = `
                        <span class="text-yellow-400 mr-2 text-xl">•</span>
                        <input type="text" class="chalk-input text-xl flex-grow" value="${todo}" oninput="app.updateTodo(${idx}, this.value)" style="font-size: ${this.settings.contactBookFontSize}px">
                        <i class="fas fa-trash cb-delete-btn" onclick="app.deleteTodo(${idx})"></i>
                    `;
                    list.appendChild(row);
                });
            },
            changeContactBookFontSize: function(delta) {
                this.settings.contactBookFontSize += delta;
                const inputs = document.querySelectorAll('#todo-list input');
                inputs.forEach(input => input.style.fontSize = this.settings.contactBookFontSize + 'px');
                this.saveToCloud();
            },
            changeIdiomFontSize: function(delta) {
                this.settings.idiomFontSize += delta;
                this.applyIdiomFontSize();
                this.saveToCloud();
            },
            applyIdiomFontSize: function() {
                const idiomInput = document.querySelector('#main-content #idiom-input');
                const idiomDesc = document.querySelector('#main-content #idiom-desc');
                if (idiomInput) idiomInput.style.fontSize = this.settings.idiomFontSize + 'px';
                if (idiomDesc) idiomDesc.style.fontSize = (this.settings.idiomFontSize * 0.9) + 'px';
            },
            saveContactBook: function() {
                const dateKey = this.getCurrentBoardDateKey();
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { todos: [] };
                this.data.contactBook[dateKey].idiom = document.getElementById('idiom-input').value;
                this.data.contactBook[dateKey].idiomDesc = document.getElementById('idiom-desc').value;
                this.saveToCloud();
            },
            addTodoItem: function() {
                const dateKey = this.getCurrentBoardDateKey();
                if (!this.data.contactBook[dateKey]) this.data.contactBook[dateKey] = { todos: [] };
                this.data.contactBook[dateKey].todos.push('');
                this.saveToCloud();
                this.renderContactBook();
            },
            updateTodo: function(idx, val) {
                const dateKey = this.getCurrentBoardDateKey();
                this.data.contactBook[dateKey].todos[idx] = val;
                this.saveToCloud();
            },
            deleteTodo: function(idx) {
                const dateKey = this.getCurrentBoardDateKey();
                this.data.contactBook[dateKey].todos.splice(idx, 1);
                this.saveToCloud();
                this.renderContactBook();
            },
            // 作業管理
            changeHomeworkDate: function(date) {
                this.currentHomeworkDate = date;
                this.renderHomeworkGrid();
            },
            renderHomeworkGrid: function() {
                const container = document.getElementById('homework-grid');
                if (!container) return;
                container.innerHTML = '';
                const dateKey = this.currentHomeworkDate;
                const dayRecord = this.data.homework[dateKey] || {};
                let pendingCount = 0;
                
                for(let i=1; i<=29; i++) { 
                    const studentData = dayRecord[i] || {};
                    const missingItems = Object.entries(studentData).filter(([k, v]) => v === 'missing').map(([k, v]) => k);
                    const resolvedItems = Object.entries(studentData).filter(([k, v]) => v === 'resolved').map(([k, v]) => k);
                    const isMissing = missingItems.length > 0;
                    if (isMissing) pendingCount++;
                    
                    const cell = document.createElement('div');
                    cell.className = `student-grid-cell relative`; 
                    cell.onclick = () => this.openHomeworkModal(i);
                    
                    let contentHtml = `
                        <div class="cell-tape"></div>
                        <div class="flex-grow flex items-center justify-center pt-1 pb-4">
                            <span class="text-3xl md:text-4xl font-bold text-white cute-font drop-shadow-md">${i}</span>
                        </div>
                    `;
                    
                    if (isMissing || resolvedItems.length > 0) {
                        contentHtml += `
                            <div class="absolute bottom-1 left-0 w-full px-1 flex flex-wrap gap-1 justify-center z-10">
                                ${missingItems.map(item => `<span class="bg-red-500 text-white text-sm md:text-base px-1.5 py-0 rounded shadow font-bold leading-tight">${item}</span>`).join('')}
                                ${resolvedItems.map(item => `<span class="bg-white text-green-700 text-sm md:text-base px-1.5 py-0 rounded shadow border border-green-300 font-bold leading-tight">${item}</span>`).join('')}
                            </div>
                        `;
                    }
                    cell.innerHTML = contentHtml;
                    container.appendChild(cell);
                }
                document.getElementById('pending-count-badge').textContent = pendingCount;
                this.renderPrintView(pendingCount);
            },
            openHomeworkModal: function(studentId) {
                this.currentEditingStudent = studentId;
                document.getElementById('modal-student-id').textContent = studentId;
                const grid = document.getElementById('homework-types-grid');
                grid.innerHTML = '';
                const dateKey = this.currentHomeworkDate;
                const studentData = (this.data.homework[dateKey] && this.data.homework[dateKey][studentId]) || {};
                
                this.settings.homeworkTypes.forEach(type => {
                    const status = studentData[type] || 'none';
                    const btn = document.createElement('button');
                    let btnClass = "border rounded-lg p-3 font-bold text-lg transition flex justify-between items-center ";
                    let iconHtml = "";
                    
                    if (status === 'missing') {
                        btnClass += "bg-red-100 border-red-500 text-red-600";
                        iconHtml = '<i class="fas fa-times-circle"></i>';
                    } else if (status === 'resolved') {
                        btnClass += "bg-green-100 border-green-500 text-green-600";
                        iconHtml = '<i class="fas fa-check-circle"></i>';
                    } else {
                        btnClass += "bg-white border-gray-200 text-gray-400 hover:border-gray-400";
                    }
                    
                    btn.className = btnClass;
                    btn.innerHTML = `<span>${type}</span>${iconHtml}`;
                    btn.onclick = () => this.toggleHomeworkStatus(type);
                    grid.appendChild(btn);
                });
                document.getElementById('homework-modal').classList.remove('hidden');
            },
            toggleHomeworkStatus: function(type) {
                const dateKey = this.currentHomeworkDate;
                if (!this.data.homework[dateKey]) this.data.homework[dateKey] = {};
                if (!this.data.homework[dateKey][this.currentEditingStudent]) this.data.homework[dateKey][this.currentEditingStudent] = {};
                
                const currentStatus = this.data.homework[dateKey][this.currentEditingStudent][type] || 'none';
                let nextStatus = 'none';
                if (currentStatus === 'none') nextStatus = 'missing';
                else if (currentStatus === 'missing') nextStatus = 'resolved';
                else nextStatus = 'none';
                
                if (nextStatus === 'none') delete this.data.homework[dateKey][this.currentEditingStudent][type];
                else this.data.homework[dateKey][this.currentEditingStudent][type] = nextStatus;
                
                this.saveToCloud();
                this.openHomeworkModal(this.currentEditingStudent);
                this.renderHomeworkGrid();
            },
            markAllResolved: function() {
                 const dateKey = this.currentHomeworkDate;
                 if (!this.data.homework[dateKey]) return;
                 const studentData = this.data.homework[dateKey][this.currentEditingStudent];
                 if (!studentData) return;
                 Object.keys(studentData).forEach(key => { if (studentData[key] === 'missing') studentData[key] = 'resolved'; });
                 this.saveToCloud();
                 this.openHomeworkModal(this.currentEditingStudent);
                 this.renderHomeworkGrid();
            },
            closeHomeworkModal: function() { document.getElementById('homework-modal').classList.add('hidden'); },
            addHomeworkType: function() {
                const input = document.getElementById('new-hw-type');
                const val = input.value.trim();
                if (val && !this.settings.homeworkTypes.includes(val)) {
                    this.settings.homeworkTypes.push(val);
                    input.value = '';
                    this.saveToCloud();
                    this.renderHomeworkGrid();
                    alert('已新增作業項目：' + val);
                }
            },
            renderPrintView: function() {
                document.getElementById('print-date').textContent = '日期：' + this.currentHomeworkDate;
                const tbody = document.getElementById('print-table-body');
                tbody.innerHTML = '';
                const dateKey = this.currentHomeworkDate;
                const dayRecord = this.data.homework[dateKey] || {};
                let hasData = false;
                for(let i=1; i<=29; i++) { 
                     const studentData = dayRecord[i] || {};
                     const missingItems = Object.entries(studentData).filter(([k, v]) => v === 'missing').map(([k, v]) => k);
                     if (missingItems.length > 0) {
                         hasData = true;
                         const tr = document.createElement('tr');
                         tr.innerHTML = `<td class="border border-black px-4 py-2 text-center text-xl font-bold">${i}</td><td class="border border-black px-4 py-2 text-xl">${missingItems.join('、')}</td>`;
                         tbody.appendChild(tr);
                     }
                }
                if (!hasData) tbody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-gray-500">今日無缺交紀錄，太棒了！</td></tr>';
            }
        };

        window.addEventListener('DOMContentLoaded', () => { app.init(); });
        window.app = app;
    </script>
</body>
</html>